{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRATrack - Inventory Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #fafafa;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;
            --accent: #8b1a1a;
            --accent-light: rgba(139,26,26,0.08);
            --accent-hover: #a02020;
            --border: #d2d2d7;
            --border-light: #e8e8ed;
            --input-bg: #ffffff;
            --card-bg: #ffffff;
            --nav-bg: rgba(255,255,255,0.72);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
            --green: #34c759;
            --green-bg: #f0fdf4;
            --green-text: #166534;
            --amber: #ff9f0a;
            --amber-bg: #fffbeb;
            --amber-text: #92400e;
            --red: #ff3b30;
            --red-bg: #fef2f2;
            --red-text: #991b1b;
            --purple: #af52de;
            --purple-bg: #faf5ff;
            --purple-text: #6b21a8;
            --blue: #007aff;
            --blue-bg: #eff6ff;
            --blue-text: #1e40af;
            --gray: #8e8e93;
            --row-hover: #f5f5f7;
        }
        body.dark-mode {
            --bg: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #0d0d0d;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-tertiary: #6e6e73;
            --accent: #ff6b6b;
            --accent-light: rgba(255,107,107,0.1);
            --accent-hover: #ff8585;
            --border: #38383a;
            --border-light: #2c2c2e;
            --input-bg: #1c1c1e;
            --card-bg: #1c1c1e;
            --nav-bg: rgba(0,0,0,0.72);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow: 0 2px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.4);
            --green: #30d158;
            --green-bg: #0a2613;
            --green-text: #4ade80;
            --amber: #ffd60a;
            --amber-bg: #2c2510;
            --amber-text: #fbbf24;
            --red: #ff453a;
            --red-bg: #2c1515;
            --red-text: #ff6b6b;
            --purple: #bf5af2;
            --purple-bg: #1f1528;
            --purple-text: #c084fc;
            --blue: #0a84ff;
            --blue-bg: #0d1f3c;
            --blue-text: #60a5fa;
            --gray: #636366;
            --row-hover: #1c1c1e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* ---- Frosted glass nav ---- */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: var(--nav-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid var(--border);
            height: 48px;
            display: flex; align-items: center; justify-content: center;
            padding: 0 24px;
        }
        .nav-inner {
            max-width: 1200px; width: 100%;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-brand {
            display: flex; align-items: center; gap: 10px; text-decoration: none;
        }
        .nav-logo {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #8b1a1a 0%, #b82e2e 100%);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 0.65rem;
        }
        body.dark-mode .nav-logo {
            background: linear-gradient(135deg, #ff6b6b 0%, #8b1a1a 100%);
        }
        .nav-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em; }
        .nav-right { display: flex; align-items: center; gap: 16px; }
        .dark-toggle-btn {
            background: none; border: none; color: var(--text-tertiary); cursor: pointer;
            display: flex; align-items: center; padding: 4px; transition: color 0.2s;
        }
        .dark-toggle-btn:hover { color: var(--text-primary); }
        .nav-logout {
            font-size: 0.8rem; color: var(--text-secondary); text-decoration: none;
            font-weight: 500; transition: color 0.2s;
        }
        .nav-logout:hover { color: var(--red); }

        /* ---- Main content ---- */
        .main { max-width: 1200px; margin: 0 auto; padding: 72px 24px 60px; }

        /* ---- Summary cards ---- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 0.5px solid var(--border-light);
            border-radius: 14px;
            padding: 18px 16px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .stat-number {
            font-size: 1.8rem; font-weight: 800; letter-spacing: -0.03em;
            line-height: 1.1; margin-bottom: 4px;
        }
        .stat-label {
            font-size: 0.65rem; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.06em; color: var(--text-tertiary);
        }
        .stat-icon {
            font-size: 1.2rem; margin-bottom: 6px; opacity: 0.6;
        }
        .stat-total .stat-number { color: var(--text-primary); }
        .stat-total .stat-icon { color: var(--text-primary); }
        .stat-in .stat-number { color: var(--green); }
        .stat-in .stat-icon { color: var(--green); }
        .stat-out .stat-number { color: var(--amber); }
        .stat-out .stat-icon { color: var(--amber); }
        .stat-damaged .stat-number { color: var(--red); }
        .stat-damaged .stat-icon { color: var(--red); }
        .stat-overdue .stat-number { color: var(--purple); }
        .stat-overdue .stat-icon { color: var(--purple); }
        .stat-archived .stat-number { color: var(--gray); }
        .stat-archived .stat-icon { color: var(--gray); }

        /* ---- Toolbar ---- */
        .toolbar {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .toolbar-group {
            display: flex; gap: 8px; align-items: center;
        }
        .btn {
            padding: 8px 16px; border-radius: 8px; font-size: 0.8rem;
            font-weight: 600; font-family: inherit; cursor: pointer;
            border: 0.5px solid var(--border); background: var(--card-bg);
            color: var(--text-primary); transition: all 0.15s; letter-spacing: -0.01em;
            text-decoration: none; white-space: nowrap;
        }
        .btn:hover { background: var(--bg-secondary); }
        .btn-primary {
            background: var(--accent); color: #fff; border-color: var(--accent);
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-teal { background: #0d9488; color: #fff; border-color: #0d9488; }
        .btn-teal:hover { background: #0f766e; }
        .btn-purple { background: #7c3aed; color: #fff; border-color: #7c3aed; }
        .btn-purple:hover { background: #6d28d9; }
        .btn-amber { background: #f59e0b; color: #fff; border-color: #f59e0b; }
        .btn-amber:hover { background: #d97706; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .toolbar-spacer { flex: 1; }

        /* More dropdown */
        .more-dropdown { position: relative; }
        .more-menu {
            display: none;
            position: absolute; right: 0; top: calc(100% + 4px);
            background: var(--card-bg);
            border: 0.5px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 200px; z-index: 100;
            overflow: hidden; padding: 4px 0;
        }
        .more-menu.open { display: block; }
        .more-menu a {
            display: block; padding: 10px 16px;
            font-size: 0.82rem; font-weight: 500;
            color: var(--text-primary); text-decoration: none;
            transition: background 0.12s;
        }
        .more-menu a:hover { background: var(--bg-secondary); }

        /* ---- Tabs ---- */
        .tabs {
            display: flex; gap: 2px; margin-bottom: 16px;
            border-bottom: 0.5px solid var(--border);
        }
        .tab {
            padding: 10px 18px; background: none; border: none;
            font-size: 0.8rem; font-weight: 500; color: var(--text-tertiary);
            cursor: pointer; border-bottom: 2px solid transparent;
            margin-bottom: -0.5px; font-family: inherit;
            transition: color 0.15s, border-color 0.15s; letter-spacing: -0.01em;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active {
            color: var(--accent); border-bottom-color: var(--accent); font-weight: 600;
        }

        /* ---- Search/filter bar ---- */
        .filter-bar {
            display: flex; gap: 10px; margin-bottom: 16px; align-items: center;
            position: sticky; top: 48px; z-index: 20;
            background: var(--bg); padding: 12px 0;
        }
        .search-input {
            flex: 1; padding: 10px 16px; padding-left: 40px;
            border: 0.5px solid var(--border); border-radius: 10px;
            font-size: 0.85rem; font-family: inherit;
            background: var(--input-bg); color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s; outline: none;
        }
        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        .search-input::placeholder { color: var(--text-tertiary); }
        .search-wrap { position: relative; flex: 1; }
        .search-wrap .material-icons {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            font-size: 1.1rem; color: var(--text-tertiary);
        }
        .filter-select {
            padding: 10px 14px; border: 0.5px solid var(--border); border-radius: 10px;
            font-size: 0.8rem; font-family: inherit; background: var(--input-bg);
            color: var(--text-primary); cursor: pointer; outline: none;
            transition: border-color 0.2s;
        }
        .filter-select:focus { border-color: var(--accent); }

        /* ---- Table ---- */
        .table-container {
            background: var(--card-bg);
            border: 0.5px solid var(--border-light);
            border-radius: 14px;
            overflow: hidden;
        }
        .table-scroll {
            overflow: auto;
            max-height: calc(100vh - 300px);
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        thead { background: var(--bg-secondary); }
        th {
            padding: 10px 16px; text-align: left; font-weight: 600;
            color: var(--text-tertiary); font-size: 0.7rem;
            text-transform: uppercase; letter-spacing: 0.04em;
            border-bottom: 0.5px solid var(--border);
            white-space: nowrap;
            background: var(--bg-secondary);
            position: sticky; top: 0; z-index: 10;
        }
        td {
            padding: 12px 16px; border-bottom: 0.5px solid var(--border-light);
            vertical-align: middle; color: var(--text-primary);
        }
        tbody tr { transition: background 0.12s; }
        tbody tr:hover td { background: var(--row-hover); }
        tbody tr:last-child td { border-bottom: none; }
        tr.selected td { background: var(--blue-bg); }
        tr.overdue-row td { background: var(--red-bg); }

        .status-badge {
            display: inline-block; padding: 3px 10px; border-radius: 999px;
            font-size: 0.68rem; font-weight: 600; letter-spacing: 0.01em;
            white-space: nowrap;
        }
        .status-checked_in { background: var(--green-bg); color: var(--green-text); }
        .status-checked_out { background: var(--amber-bg); color: var(--amber-text); }
        .status-tested { background: var(--blue-bg); color: var(--blue-text); }
        .status-will_be_reused { background: var(--purple-bg); color: var(--purple-text); }
        .status-recycling { background: #fdf2f8; color: #9d174d; }
        body.dark-mode .status-recycling { background: #2c1525; color: #f472b6; }

        .overdue-badge {
            display: inline-block; padding: 2px 8px; border-radius: 999px;
            font-size: 0.65rem; font-weight: 700;
            background: var(--amber); color: var(--amber-text);
            margin-left: 6px;
        }

        .damage-yes { color: var(--red); font-weight: 600; }
        .damage-no { color: var(--green); }

        .desc-cell { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .desc-cell:hover { white-space: normal; overflow: visible; }

        .tag-badge {
            display: inline-block; padding: 2px 8px; border-radius: 999px;
            font-size: 0.65rem; font-weight: 500; background: var(--accent-light);
            color: var(--accent); margin: 1px 2px; white-space: nowrap;
        }

        /* Pallet group row */
        .pallet-group-row td {
            background: var(--bg-secondary) !important; padding: 8px 16px;
            font-weight: 600; font-size: 0.82rem; cursor: pointer;
            border-bottom: 0.5px solid var(--border);
        }
        .pallet-group-row:hover td { background: var(--bg-tertiary) !important; }
        .pallet-group-row .toggle-arrow {
            display: inline-block; transition: transform 0.2s;
            margin-right: 8px; font-size: 0.75rem;
        }
        .pallet-group-row.collapsed .toggle-arrow { transform: rotate(-90deg); }
        .pallet-group-row .group-count {
            color: var(--text-tertiary); font-weight: 400; font-size: 0.75rem; margin-left: 8px;
        }

        .view-link {
            color: var(--accent); text-decoration: none; font-weight: 500; font-size: 0.8rem;
        }
        .view-link:hover { text-decoration: underline; }
        .view-col { position: sticky; right: 0; background: var(--card-bg); }
        thead .view-col { background: var(--bg-secondary); z-index: 11; }
        tr:hover .view-col { background: var(--row-hover); }
        tr.selected .view-col { background: var(--blue-bg); }
        tr.overdue-row .view-col { background: var(--red-bg); }

        .empty-state {
            padding: 60px 24px; text-align: center; color: var(--text-tertiary);
        }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); }
        .empty-state a { color: var(--accent); }

        .checkbox-col { width: 40px; text-align: center; }
        .checkbox-col input { width: 15px; height: 15px; cursor: pointer; accent-color: var(--accent); }

        /* Collapse All toggle */
        .collapse-all-btn {
            background: none; border: none; cursor: pointer; padding: 2px;
            margin-left: 4px; color: var(--text-tertiary);
            display: inline-flex; align-items: center;
            transition: transform 0.2s; vertical-align: middle;
        }
        .collapse-all-btn:hover { color: var(--text-primary); }
        .collapse-all-btn.collapsed { transform: rotate(-90deg); }

        /* ---- Bulk action bar ---- */
        .bulk-bar {
            display: none;
            background: #1e3a5f; color: #fff;
            padding: 12px 20px; border-radius: 12px;
            margin-bottom: 16px; align-items: center;
            gap: 12px; flex-wrap: wrap;
            position: sticky; top: 100px; z-index: 19;
        }
        .bulk-bar.active { display: flex; }
        .bulk-bar span { font-size: 0.82rem; font-weight: 600; }
        .bulk-bar select, .bulk-bar input {
            padding: 6px 10px; border-radius: 8px;
            border: 0.5px solid var(--border); font-size: 0.8rem;
            background: var(--input-bg); color: var(--text-primary);
            font-family: inherit;
        }
        .bulk-bar .btn-bulk {
            padding: 8px 16px; border: none; border-radius: 8px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer; color: #fff;
        }
        .bulk-bar .btn-bulk.apply { background: #16a34a; }
        .bulk-bar .btn-bulk.archive { background: #f59e0b; color: #1a1a2e; }
        .bulk-bar .btn-bulk.cancel { background: #64748b; }

        /* ---- Modal ---- */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--card-bg);
            border: 0.5px solid var(--border);
            border-radius: 16px;
            max-width: 480px; width: 90%;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 0.5px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
        .modal-close {
            background: none; border: none;
            color: var(--text-tertiary); font-size: 1.5rem; cursor: pointer;
        }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 20px; text-align: center; }
        #qr-reader { width: 100%; border: none !important; }
        #qr-reader video { border-radius: 8px; }
        #qr-reader__scan_region { border: none !important; }
        #qr-reader__dashboard { margin-top: 10px; }
        #qr-reader__dashboard button {
            padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;
        }
        .scanner-status {
            margin-top: 12px; font-size: 0.85rem; color: var(--text-secondary);
        }

        /* Multi-scan */
        .multiscan-list { margin: 16px 0; max-height: 250px; overflow-y: auto; }
        .multiscan-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; border-bottom: 0.5px solid var(--border-light);
            font-size: 0.85rem;
        }
        .multiscan-item .item-info { font-weight: 500; }
        .multiscan-item .item-tag-id { color: var(--text-tertiary); font-size: 0.75rem; }
        .multiscan-item .remove-btn {
            background: var(--red-bg); color: var(--red-text); border: none; border-radius: 8px;
            padding: 4px 10px; font-size: 0.75rem; cursor: pointer;
        }
        .multiscan-actions {
            border-top: 0.5px solid var(--border); padding-top: 16px; margin-top: 8px;
        }
        .multiscan-actions select, .multiscan-actions input {
            padding: 8px 12px; border: 0.5px solid var(--border); border-radius: 10px;
            font-size: 0.85rem; width: 100%; margin-bottom: 8px;
            background: var(--input-bg); color: var(--text-primary); font-family: inherit;
        }
        .multiscan-actions .btn-apply {
            width: 100%; padding: 12px; background: #16a34a; color: #fff;
            border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; font-family: inherit;
        }
        .multiscan-actions .btn-apply:hover { opacity: 0.9; }
        .multiscan-actions .btn-apply:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ---- Overdue banner ---- */
        .overdue-banner {
            background: var(--amber-bg); border: 0.5px solid var(--amber);
            border-radius: 12px; padding: 12px 18px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px; font-size: 0.85rem;
        }
        .overdue-banner .material-icons { color: var(--amber); font-size: 1.3rem; }
        .overdue-banner .text { color: var(--amber-text); }
        .overdue-banner .text strong { font-weight: 700; }
        .overdue-banner .text a { color: var(--accent); text-decoration: underline; }

        /* ---- Activity feed ---- */
        .activity-section {
            margin-top: 32px;
            background: var(--card-bg);
            border: 0.5px solid var(--border-light);
            border-radius: 14px;
            padding: 24px;
        }
        .activity-section h3 {
            font-size: 0.8rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.06em; color: var(--text-tertiary);
            margin-bottom: 16px; padding-bottom: 12px;
            border-bottom: 0.5px solid var(--border-light);
        }
        .activity-row {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 0; border-bottom: 0.5px solid var(--border-light);
            font-size: 0.8rem;
        }
        .activity-row:last-child { border-bottom: none; }
        .activity-badge {
            padding: 3px 8px; border-radius: 6px; font-size: 0.65rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em;
            flex-shrink: 0; min-width: 50px; text-align: center; white-space: nowrap;
        }
        .badge-status { background: var(--blue-bg); color: var(--blue-text); }
        .badge-edit { background: var(--amber-bg); color: var(--amber-text); }
        .badge-created { background: var(--green-bg); color: var(--green-text); }
        .activity-text { flex: 1; color: var(--text-primary); }
        .activity-text strong { font-weight: 600; }
        .activity-text em { color: var(--purple); font-style: normal; font-weight: 500; }
        .activity-time { color: var(--text-tertiary); font-size: 0.7rem; flex-shrink: 0; }

        /* ---- Mobile card view ---- */
        .mobile-cards { display: none; }
        .mobile-card {
            background: var(--card-bg);
            border: 0.5px solid var(--border-light);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .mobile-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .mobile-card-title { font-weight: 600; font-size: 0.95rem; color: var(--text-primary); }
        .mobile-card-subtitle { font-size: 0.78rem; color: var(--text-tertiary); margin-top: 2px; }
        .mobile-card-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px;
            font-size: 0.78rem;
        }
        .mobile-card-field { display: flex; flex-direction: column; gap: 2px; }
        .mobile-card-label {
            font-size: 0.65rem; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.04em; color: var(--text-tertiary);
        }
        .mobile-card-value {
            font-weight: 500; color: var(--text-primary);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .mobile-card-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 12px; padding-top: 10px;
            border-top: 0.5px solid var(--border-light);
        }
        .mobile-card-tags { display: flex; gap: 4px; flex-wrap: wrap; }
        .mobile-group-header {
            font-weight: 600; font-size: 0.85rem; padding: 10px 0 6px;
            color: var(--text-primary); border-bottom: 0.5px solid var(--border-light);
            margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
            cursor: pointer; user-select: none;
        }
        .mobile-group-header .group-count {
            color: var(--text-tertiary); font-weight: 400; font-size: 0.75rem;
        }
        .mobile-group-header .toggle-arrow {
            display: inline-block; transition: transform 0.2s; font-size: 0.75rem;
        }
        .mobile-group-header.collapsed .toggle-arrow { transform: rotate(-90deg); }

        /* ---- Responsive ---- */
        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .stat-number { font-size: 1.4rem; }
            .stat-card { padding: 14px 10px; }
            .toolbar {
                display: grid; grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .toolbar-group {
                display: contents;
            }
            .toolbar-spacer { display: none; }
            .btn { text-align: center; padding: 10px 12px; font-size: 0.78rem; }
            .tabs { overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
            .tab { white-space: nowrap; padding: 10px 14px; font-size: 0.78rem; }
            .filter-bar { flex-direction: column; top: 48px; }
            .table-container { display: none; }
            .mobile-cards { display: block; }
            .overdue-banner { font-size: 0.8rem; padding: 10px 14px; }
            .activity-section { padding: 18px; }
            .activity-row { flex-wrap: wrap; gap: 6px; }
            .activity-time { width: 100%; text-align: right; }
            .bulk-bar { padding: 10px 12px; gap: 8px; flex-direction: column; align-items: stretch; }
            .bulk-bar select, .bulk-bar input { width: 100%; }
        }
        @media (max-width: 480px) {
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-number { font-size: 1.2rem; }
            .stat-label { font-size: 0.6rem; }
            .stat-icon { font-size: 1rem; }
            .main { padding: 60px 14px 40px; }
        }
    </style>
</head>
<body>
    <!-- Frosted glass nav -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="/dashboard/" class="nav-brand">
                <div class="nav-logo">FR</div>
                <span class="nav-title">FRATrack</span>
            </a>
            <div class="nav-right">
                <button class="dark-toggle-btn" onclick="toggleDarkMode()" id="darkToggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <a href="/accounts/logout/" class="nav-logout">Sign Out</a>
            </div>
        </div>
    </nav>

    <div class="main">
        <!-- Overdue Alert Banner -->
        {% if overdue_count > 0 and not show_archived %}
        <div class="overdue-banner">
            <span class="material-icons">warning_amber</span>
            <div class="text">
                <strong>{{ overdue_count }} item{{ overdue_count|pluralize }} overdue</strong> — checked out for more than 7 days.
                <a href="#" onclick="switchTab('overdue'); return false;">View overdue items</a>
            </div>
        </div>
        {% endif %}

        <!-- Summary cards -->
        <div class="summary-grid">
            <div class="stat-card stat-total">
                <span class="material-icons stat-icon">inventory_2</span>
                <div class="stat-number">{{ items|length }}</div>
                <div class="stat-label">{% if show_archived %}Archived{% else %}Total Items{% endif %}</div>
            </div>
            <div class="stat-card stat-in">
                <span class="material-icons stat-icon">check_circle</span>
                <div class="stat-number">{{ checked_in_count }}</div>
                <div class="stat-label">Checked In</div>
            </div>
            <div class="stat-card stat-out">
                <span class="material-icons stat-icon">local_shipping</span>
                <div class="stat-number">{{ checked_out_count }}</div>
                <div class="stat-label">Checked Out</div>
            </div>
            <div class="stat-card stat-damaged">
                <span class="material-icons stat-icon">warning</span>
                <div class="stat-number">{{ damaged_count }}</div>
                <div class="stat-label">Damaged</div>
            </div>
            <div class="stat-card stat-overdue">
                <span class="material-icons stat-icon">schedule</span>
                <div class="stat-number">{{ overdue_count }}</div>
                <div class="stat-label">Overdue</div>
            </div>
            <div class="stat-card stat-archived">
                <span class="material-icons stat-icon">archive</span>
                <div class="stat-number">{{ archived_count }}</div>
                <div class="stat-label">Archived</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <a class="btn btn-primary" href="/add-shipment/">Add Shipment</a>
                <button class="btn btn-teal" onclick="openScanner()">
                    <span class="material-icons" style="font-size:14px;vertical-align:middle;margin-right:4px;">qr_code_scanner</span>
                    Scan QR
                </button>
                <button class="btn btn-purple" onclick="openMultiScan()">Multi-Scan</button>
                <a class="btn btn-amber" href="/test-print/" target="_blank">Test Print</a>
            </div>
            <div class="toolbar-spacer"></div>
            <div class="toolbar-group">
                <div class="more-dropdown">
                    <button class="btn" onclick="toggleMoreMenu()">
                        <span class="material-icons" style="font-size:16px;vertical-align:middle;">more_horiz</span>
                    </button>
                    <div class="more-menu" id="moreMenu">
                        <a href="/shipments/">Shipments</a>
                        <a href="/tags/">Manage Tags</a>
                        <a href="/export/csv/{% if show_archived %}?archived=1{% endif %}">Export CSV</a>
                        <a href="/export/pdf/{% if show_archived %}?archived=1{% endif %}" target="_blank">Print Report</a>
                        {% if show_archived %}
                        <a href="/dashboard/">View Active Inventory</a>
                        {% else %}
                        <a href="/dashboard/?archived=1">View Archive ({{ archived_count }})</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('all')">{% if show_archived %}All Archived{% else %}All Inventory{% endif %}</button>
            {% if not show_archived %}
            <button class="tab" onclick="switchTab('checkedin')">Checked In</button>
            <button class="tab" onclick="switchTab('checkedout')">Checked Out</button>
            <button class="tab" onclick="switchTab('tested')">Tested</button>
            <button class="tab" onclick="switchTab('willbereused')">Will Be Reused</button>
            <button class="tab" onclick="switchTab('recycling')">Recycling</button>
            <button class="tab" onclick="switchTab('damaged')">Damaged</button>
            <button class="tab" onclick="switchTab('overdue')">Overdue</button>
            {% endif %}
        </div>

        <div class="inventory-section">
        <!-- Filters -->
        <div class="filter-bar">
            <div class="search-wrap">
                <span class="material-icons">search</span>
                <input class="search-input" type="text" id="searchInput" placeholder="Search by manufacturer, pallet, project, location, tags..." oninput="debouncedFilter()">
            </div>
            <select class="filter-select" id="statusFilter" onchange="filterTable()">
                <option value="">All Statuses</option>
                <option value="checked_in">Checked In</option>
                <option value="checked_out">Checked Out</option>
                <option value="tested">Tested</option>
                <option value="will_be_reused">Will Be Reused</option>
                <option value="recycling">Recycling</option>
            </select>
            <select class="filter-select" id="sortFilter" onchange="sortPalletGroups()">
                <option value="recent">Date Added (Newest)</option>
                <option value="oldest">Date Added (Oldest)</option>
                <option value="updated">Last Updated (Newest)</option>
                <option value="largest">Quantity (High to Low)</option>
                <option value="smallest">Quantity (Low to High)</option>
            </select>
        </div>

        <!-- Bulk Action Bar -->
        <div class="bulk-bar" id="bulkBar">
            <span id="selectedCount">0 selected</span>
            <select id="bulkStatus">
                <option value="">Change Status To...</option>
                <option value="checked_in">Checked In</option>
                <option value="checked_out">Checked Out</option>
                <option value="tested">Tested</option>
                <option value="will_be_reused">Will Be Reused</option>
                <option value="recycling">Recycling</option>
            </select>
            <input type="text" id="bulkChangedBy" placeholder="Your name" style="width:150px;">
            <button class="btn-bulk apply" onclick="applyBulkStatus()">Apply Status</button>
            <span style="border-left:1px solid #4b5563; height:24px;"></span>
            <select id="bulkLocation" style="width:140px;">
                <option value="">Set Location...</option>
                {% for loc in location_choices %}
                <option value="{{ loc }}">{{ loc }}</option>
                {% endfor %}
            </select>
            <select id="bulkDamaged" style="width:120px;">
                <option value="">Set Damage...</option>
                <option value="true">Damaged: Yes</option>
                <option value="false">Damaged: No</option>
            </select>
            <button class="btn-bulk apply" onclick="applyBulkEdit()">Apply Edit</button>
            <span style="border-left:1px solid #4b5563; height:24px;"></span>
            {% if show_archived %}
            <button class="btn-bulk archive" onclick="applyBulkArchive(false)">Unarchive Selected</button>
            {% else %}
            <button class="btn-bulk archive" onclick="applyBulkArchive(true)">Archive Selected</button>
            {% endif %}
            <button class="btn-bulk cancel" onclick="clearSelection()">Cancel</button>
        </div>

        <!-- Desktop Table -->
        {% if items %}
        <div class="table-container">
            <div class="table-scroll">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th class="checkbox-col">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <button id="btnCollapseAll" class="collapse-all-btn" onclick="toggleAllGroups()" title="Collapse All"><span class="material-icons" style="font-size:18px;">expand_more</span></button>
                        </th>
                        <th>Manufacturer</th>
                        <th>Pallet ID</th>
                        <th>Project #</th>
                        <th>Box</th>
                        <th>Contents</th>
                        <th>Damage</th>
                        <th>Location</th>
                        <th>Description</th>
                        <th>Tag ID</th>
                        <th>Tags</th>
                        <th>Status</th>
                        {% if not show_archived %}<th>Checked Out By</th>{% endif %}
                        <th>Updated</th>
                        <th class="view-col"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr data-id="{{ item.id }}" data-status="{{ item.status }}" data-damaged="{{ item.damaged|yesno:'true,false' }}"
                        data-overdue="{{ item.is_overdue|yesno:'true,false' }}"
                        data-pallet="{{ item.pallet_id|lower }}"
                        data-created="{{ item.created_at|date:'U' }}" data-updated="{{ item.updated_at|date:'U' }}"
                        data-search="{{ item.manufacturer|lower }} {{ item.pallet_id|lower }} {{ item.project_number|lower }} {{ item.location|lower }} {{ item.description|lower }} {{ item.checked_out_by|lower }} {{ item.tag_id|lower }} {{ item.tags|lower }}"
                        class="{% if item.is_overdue %}overdue-row{% endif %} pallet-item">
                        <td class="checkbox-col"><input type="checkbox" class="row-check" value="{{ item.id }}" onchange="updateSelection()"></td>
                        <td style="font-weight:500;">{{ item.manufacturer }}</td>
                        <td>{{ item.pallet_id }}</td>
                        <td>{{ item.project_number|default:"-" }}</td>
                        <td>#{{ item.box_id }}</td>
                        <td>{{ item.content }}</td>
                        <td class="{% if item.damaged %}damage-yes{% else %}damage-no{% endif %}">
                            {{ item.get_damaged_display }}
                        </td>
                        <td>{{ item.location }}</td>
                        <td class="desc-cell" title="{{ item.description }}">{{ item.description|truncatewords:8 }}</td>
                        <td style="font-weight:600; font-size:0.78rem; white-space:nowrap;">{{ item.tag_id }}</td>
                        <td>
                            {% for tag in item.tags_list %}
                            <span class="tag-badge">{{ tag }}</span>
                            {% endfor %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ item.status }}">{{ item.get_status_display }}</span>
                            {% if item.is_overdue %}<span class="overdue-badge">{{ item.days_checked_out }}d overdue</span>{% endif %}
                        </td>
                        {% if not show_archived %}
                        <td>{{ item.checked_out_by|default:"-" }}</td>
                        {% endif %}
                        <td style="color:var(--text-tertiary); font-size:0.78rem;">{{ item.updated_at|date:"M d, H:i" }}</td>
                        <td class="view-col"><a class="view-link" href="/scan/?id={{ item.id }}">View</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>

        <!-- Mobile Card View -->
        <div class="mobile-cards" id="mobileCards">
            {% for item in items %}
            {% ifchanged item.pallet_id %}
            <div class="mobile-group-header collapsed" data-mobile-group="{{ item.pallet_id|lower }}" onclick="toggleMobileGroup(this)">
                <span class="toggle-arrow">&#9660;</span>
                Pallet {{ item.pallet_id }}
                <span class="group-count"></span>
            </div>
            {% endifchanged %}
            <div class="mobile-card pallet-item-mobile"
                 data-id="{{ item.id }}" data-status="{{ item.status }}"
                 data-damaged="{{ item.damaged|yesno:'true,false' }}"
                 data-overdue="{{ item.is_overdue|yesno:'true,false' }}"
                 data-mobile-pallet="{{ item.pallet_id|lower }}"
                 data-pallet="{{ item.pallet_id|lower }}"
                 data-search="{{ item.manufacturer|lower }} {{ item.pallet_id|lower }} {{ item.project_number|lower }} {{ item.location|lower }} {{ item.description|lower }} {{ item.checked_out_by|lower }} {{ item.tag_id|lower }} {{ item.tags|lower }}"
                 style="display:none;">
                <div class="mobile-card-header">
                    <div>
                        <div class="mobile-card-title">{{ item.manufacturer }} — Box #{{ item.box_id }}</div>
                        <div class="mobile-card-subtitle">Pallet {{ item.pallet_id }} · Project {{ item.project_number|default:"-" }}</div>
                    </div>
                    <span class="status-badge status-{{ item.status }}">{{ item.get_status_display }}</span>
                </div>
                <div class="mobile-card-grid">
                    <div class="mobile-card-field">
                        <span class="mobile-card-label">Contents</span>
                        <span class="mobile-card-value">{{ item.content }}</span>
                    </div>
                    <div class="mobile-card-field">
                        <span class="mobile-card-label">Location</span>
                        <span class="mobile-card-value">{{ item.location }}</span>
                    </div>
                    <div class="mobile-card-field">
                        <span class="mobile-card-label">Damage</span>
                        <span class="mobile-card-value {% if item.damaged %}damage-yes{% else %}damage-no{% endif %}">{{ item.get_damaged_display }}</span>
                    </div>
                    <div class="mobile-card-field">
                        <span class="mobile-card-label">Updated</span>
                        <span class="mobile-card-value" style="color:var(--text-tertiary);">{{ item.updated_at|date:"M d, H:i" }}</span>
                    </div>
                </div>
                <div class="mobile-card-footer">
                    <div class="mobile-card-tags">
                        {% for tag in item.tags_list %}
                        <span class="tag-badge">{{ tag }}</span>
                        {% endfor %}
                        {% if item.is_overdue %}<span class="tag-badge" style="background:var(--red-bg);color:var(--red-text);">{{ item.days_checked_out }}d overdue</span>{% endif %}
                    </div>
                    <a class="view-link" href="/scan/?id={{ item.id }}">View Details &rarr;</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>{% if show_archived %}No archived items{% else %}No inventory items yet{% endif %}</h3>
            <p>{% if show_archived %}Archive items from the main inventory view.{% else %}<a href="/add-shipment/">Add a shipment</a> to create inventory items and generate QR codes.{% endif %}</p>
        </div>
        {% endif %}
        </div>

        <!-- Activity Feed -->
        {% if recent_activity %}
        <div class="activity-section">
            <h3>Recent Activity</h3>
            {% for entry in recent_activity %}
            <div class="activity-row">
                {% if entry.entry_type == 'status' %}
                <span class="activity-badge badge-status">Status</span>
                <span class="activity-text">
                    <strong>{{ entry.item.manufacturer }}</strong> Box #{{ entry.item.box_id }}:
                    {{ entry.old_status_label }} &rarr; {{ entry.new_status_label }}
                    {% if entry.changed_by %}<em> by {{ entry.changed_by }}</em>{% endif %}
                </span>
                {% elif entry.change_type == 'created' %}
                <span class="activity-badge badge-created">Created</span>
                <span class="activity-text">
                    <strong>{{ entry.item.manufacturer }}</strong> Box #{{ entry.item.box_id }} checked in
                </span>
                {% else %}
                <span class="activity-badge badge-edit">Edit</span>
                <span class="activity-text">
                    <strong>{{ entry.item.manufacturer }}</strong> Box #{{ entry.item.box_id }}:
                    {{ entry.field_label }} changed
                    {% if entry.changed_by %}<em> by {{ entry.changed_by }}</em>{% endif %}
                </span>
                {% endif %}
                <span class="activity-time">{{ entry.changed_at|timesince }} ago</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal-overlay" id="scannerModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Scan QR Code</h3>
                <button class="modal-close" onclick="closeScanner()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="qr-reader"></div>
                <div class="scanner-status" id="scannerStatus">Initializing camera...</div>
            </div>
        </div>
    </div>

    <!-- Multi-Scan Modal -->
    <div class="modal-overlay" id="multiScanModal">
        <div class="modal" style="max-width:520px;">
            <div class="modal-header">
                <h3>Multi-Scan</h3>
                <button class="modal-close" onclick="closeMultiScan()">&times;</button>
            </div>
            <div class="modal-body" style="text-align:left;">
                <p style="font-size:0.85rem; color:var(--text-tertiary); margin-bottom:12px;">Scan multiple QR codes, then set their status at once.</p>
                <div id="multi-qr-reader"></div>
                <div class="scanner-status" id="multiScannerStatus">Click scan to start camera</div>
                <div style="text-align:center; margin:8px 0;">
                    <button id="multiScanStartBtn" onclick="startMultiScanner()" class="btn btn-purple" style="display:inline-block;">Start Scanning</button>
                    <button id="multiScanStopBtn" onclick="stopMultiScanner()" class="btn" style="display:none;">Pause</button>
                </div>
                <div class="multiscan-list" id="multiScanList">
                    <p style="color:var(--text-tertiary); text-align:center; font-size:0.85rem;" id="multiScanEmpty">No items scanned yet.</p>
                </div>
                <div class="multiscan-actions" id="multiScanActions" style="display:none;">
                    <select id="multiScanStatus">
                        <option value="">Select Status...</option>
                        <option value="checked_in">Checked In</option>
                        <option value="checked_out">Checked Out</option>
                        <option value="tested">Tested</option>
                        <option value="will_be_reused">Will Be Reused</option>
                        <option value="recycling">Recycling</option>
                    </select>
                    <input type="text" id="multiScanChangedBy" placeholder="Your name (optional)">
                    <button class="btn-apply" id="multiScanApply" onclick="applyMultiScanStatus()">Apply Status to All</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // ---- More dropdown ----
        function toggleMoreMenu() {
            document.getElementById('moreMenu').classList.toggle('open');
        }
        function closeMoreMenu() {
            document.getElementById('moreMenu').classList.remove('open');
        }
        document.addEventListener('click', function(e) {
            var dropdown = document.querySelector('.more-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                closeMoreMenu();
            }
        });

        // ---- Tab switching ----
        let currentTab = 'all';
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const statusFilter = document.getElementById('statusFilter');
            if (tab === 'all') statusFilter.value = '';
            else if (tab === 'checkedin') statusFilter.value = 'checked_in';
            else if (tab === 'checkedout') statusFilter.value = 'checked_out';
            else if (tab === 'tested') statusFilter.value = 'tested';
            else if (tab === 'willbereused') statusFilter.value = 'will_be_reused';
            else if (tab === 'recycling') statusFilter.value = 'recycling';
            else if (tab === 'damaged') statusFilter.value = '';
            else if (tab === 'overdue') statusFilter.value = '';

            filterTable();
        }

        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#inventoryTable tbody tr.pallet-item');

            rows.forEach(row => {
                const matchSearch = !search || (row.dataset.search && row.dataset.search.includes(search));
                let matchStatus = !status || row.dataset.status === status;
                let matchTab = true;

                if (currentTab === 'damaged') matchTab = row.dataset.damaged === 'true';
                if (currentTab === 'overdue') matchTab = row.dataset.overdue === 'true';

                row.style.display = (matchSearch && matchStatus && matchTab) ? '' : 'none';
            });

            // Show/hide group headers based on whether any child items are visible
            document.querySelectorAll('.pallet-group-row').forEach(groupRow => {
                const key = groupRow.dataset.palletGroup;
                const childRows = document.querySelectorAll(`tr.pallet-item[data-pallet="${key}"]`);
                const anyVisible = Array.from(childRows).some(r => r.style.display !== 'none');
                groupRow.style.display = anyVisible ? '' : 'none';

                // Respect collapsed state
                if (groupRow.classList.contains('collapsed')) {
                    childRows.forEach(r => r.style.display = 'none');
                }
            });

            // Also filter mobile cards
            document.querySelectorAll('.mobile-group-header').forEach(header => {
                const key = header.dataset.mobileGroup;
                const cards = document.querySelectorAll(`.pallet-item-mobile[data-mobile-pallet="${key}"]`);
                let anyVisible = false;

                cards.forEach(card => {
                    const matchSearch = !search || (card.dataset.search && card.dataset.search.includes(search));
                    let matchStatus = !status || card.dataset.status === status;
                    let matchTab = true;

                    if (currentTab === 'damaged') matchTab = card.dataset.damaged === 'true';
                    if (currentTab === 'overdue') matchTab = card.dataset.overdue === 'true';

                    const matchesFilter = matchSearch && matchStatus && matchTab;
                    if (matchesFilter) anyVisible = true;

                    // Show card only if it matches AND the group is expanded
                    card.style.display = (matchesFilter && !header.classList.contains('collapsed')) ? '' : 'none';
                });

                // Show/hide the group header based on whether any cards match
                header.style.display = anyVisible ? '' : 'none';
            });
        }

        // ---- Selection & Bulk actions ----
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.row-check').forEach(cb => {
                const row = cb.closest('tr');
                if (row.style.display !== 'none') {
                    cb.checked = checked;
                    row.classList.toggle('selected', checked);
                }
            });
            updateSelection();
        }

        function updateSelection() {
            const checked = document.querySelectorAll('.row-check:checked');
            const count = checked.length;
            document.getElementById('selectedCount').textContent = count + ' selected';
            document.getElementById('bulkBar').classList.toggle('active', count > 0);

            document.querySelectorAll('.row-check').forEach(cb => {
                cb.closest('tr').classList.toggle('selected', cb.checked);
            });
        }

        function clearSelection() {
            document.getElementById('selectAll').checked = false;
            document.querySelectorAll('.row-check').forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('selected');
            });
            updateSelection();
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.row-check:checked')).map(cb => parseInt(cb.value));
        }

        async function applyBulkStatus() {
            const ids = getSelectedIds();
            const status = document.getElementById('bulkStatus').value;
            const changedBy = document.getElementById('bulkChangedBy').value;

            if (!ids.length) return showToast('No items selected', true);
            if (!status) return showToast('Select a status', true);

            const statusLabels = {checked_in:'Checked In',checked_out:'Checked Out',tested:'Tested',will_be_reused:'Will Be Reused',recycling:'Recycling'};
            if (!confirm(`Change status of ${ids.length} item(s) to "${statusLabels[status] || status}"?`)) return;

            try {
                const resp = await fetch('/api/bulk-update-status/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({item_ids: ids, status: status, changed_by: changedBy})
                });
                const data = await resp.json();
                if (data.success) {
                    location.reload();
                } else {
                    showToast('Error: ' + data.error, true);
                }
            } catch (err) {
                showToast('Network error', true);
            }
        }

        async function applyBulkArchive(archive) {
            const ids = getSelectedIds();
            if (!ids.length) return showToast('No items selected', true);

            const action = archive ? 'archive' : 'unarchive';
            if (!confirm('Are you sure you want to ' + action + ' ' + ids.length + ' item(s)?')) return;

            try {
                const resp = await fetch('/api/bulk-archive/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({item_ids: ids, archive: archive})
                });
                const data = await resp.json();
                if (data.success) {
                    location.reload();
                } else {
                    showToast('Error: ' + data.error, true);
                }
            } catch (err) {
                showToast('Network error', true);
            }
        }

        function showToast(message, isError) {
            let toast = document.getElementById('toastNotif');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastNotif';
                toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:12px;font-size:0.85rem;font-weight:600;color:#fff;z-index:9999;transition:opacity 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.2);font-family:Inter,sans-serif;';
                document.body.appendChild(toast);
            }
            toast.style.background = isError ? '#dc2626' : '#16a34a';
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        // ---- QR Scanner (html5-qrcode) ----
        let html5QrCode = null;

        function openScanner() {
            document.getElementById('scannerModal').classList.add('active');
            startScanner();
        }

        function closeScanner() {
            document.getElementById('scannerModal').classList.remove('active');
            stopScanner();
        }

        async function startScanner() {
            const statusEl = document.getElementById('scannerStatus');
            statusEl.textContent = 'Initializing camera...';

            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => {
                        stopScanner();
                        handleScanResult(decodedText);
                    },
                    (errorMessage) => {}
                );
                statusEl.textContent = 'Point your camera at a QR code...';
            } catch (err) {
                statusEl.textContent = 'Camera access denied or not available. Please allow camera permissions and try again.';
                console.error('Scanner error:', err);
            }
        }

        async function stopScanner() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                } catch (e) {}
                html5QrCode = null;
            }
        }

        function handleScanResult(text) {
            closeScanner();
            if (text.includes('/scan/')) {
                window.location.href = text;
            } else if (/^\d+$/.test(text)) {
                window.location.href = '/scan/?id=' + text;
            } else {
                window.location.href = '/scan/?data=' + encodeURIComponent(text);
            }
        }

        // ---- Collapsible Pallet Groups ----
        function initPalletGroups() {
            const tbody = document.querySelector('#inventoryTable tbody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr.pallet-item'));
            if (!rows.length) return;

            const seen = new Set();
            const palletOrder = [];
            rows.forEach(row => {
                const key = row.dataset.pallet;
                if (!seen.has(key)) {
                    seen.add(key);
                    palletOrder.push(key);
                }
            });

            const colCount = tbody.closest('table').querySelector('thead tr').children.length;

            palletOrder.forEach(key => {
                const groupRows = rows.filter(r => r.dataset.pallet === key);
                const firstRow = groupRows[0];
                const palletId = firstRow.children[2].textContent.trim();

                const groupRow = document.createElement('tr');
                groupRow.className = 'pallet-group-row collapsed';
                groupRow.dataset.palletGroup = key;
                groupRow.innerHTML = `<td colspan="${colCount}"><span class="toggle-arrow">&#9660;</span>Pallet ${escapeHtml(palletId)}<span class="group-count">(${groupRows.length} item${groupRows.length === 1 ? '' : 's'})</span></td>`;

                firstRow.parentNode.insertBefore(groupRow, firstRow);
                groupRows.forEach(r => r.style.display = 'none');

                groupRow.addEventListener('click', () => {
                    const isCollapsed = groupRow.classList.toggle('collapsed');
                    groupRows.forEach(r => {
                        r.style.display = isCollapsed ? 'none' : '';
                    });
                });
            });

            const btn = document.getElementById('btnCollapseAll');
            if (btn) {
                btn.classList.add('collapsed');
                btn.title = 'Expand All';
            }

            sortPalletGroups();
        }

        // ---- Sort Pallet Groups ----
        function sortPalletGroups() {
            const tbody = document.querySelector('#inventoryTable tbody');
            if (!tbody) return;
            const sortBy = document.getElementById('sortFilter').value;

            const groupRows = Array.from(document.querySelectorAll('.pallet-group-row'));
            if (!groupRows.length) return;

            const groups = groupRows.map(header => {
                const key = header.dataset.palletGroup;
                const itemRows = Array.from(document.querySelectorAll(`tr.pallet-item[data-pallet="${key}"]`));

                let sortValue = 0;
                if (sortBy === 'recent' || sortBy === 'oldest') {
                    sortValue = sortBy === 'recent'
                        ? Math.max(...itemRows.map(r => parseInt(r.dataset.created) || 0))
                        : Math.min(...itemRows.map(r => parseInt(r.dataset.created) || 0));
                } else if (sortBy === 'updated') {
                    sortValue = Math.max(...itemRows.map(r => parseInt(r.dataset.updated) || 0));
                } else if (sortBy === 'largest') {
                    sortValue = itemRows.length;
                } else if (sortBy === 'smallest') {
                    sortValue = itemRows.length;
                }

                return { header, itemRows, sortValue };
            });

            if (sortBy === 'smallest' || sortBy === 'oldest') {
                groups.sort((a, b) => a.sortValue - b.sortValue);
            } else {
                groups.sort((a, b) => b.sortValue - a.sortValue);
            }

            groups.forEach(group => {
                tbody.appendChild(group.header);
                group.itemRows.forEach(row => tbody.appendChild(row));
            });
        }

        function toggleAllGroups() {
            const groupRows = document.querySelectorAll('.pallet-group-row');
            if (!groupRows.length) return;
            const btn = document.getElementById('btnCollapseAll');
            const anyExpanded = Array.from(groupRows).some(r => !r.classList.contains('collapsed'));
            groupRows.forEach(groupRow => {
                const key = groupRow.dataset.palletGroup;
                const itemRows = document.querySelectorAll(`tr.pallet-item[data-pallet="${key}"]`);
                if (anyExpanded) {
                    groupRow.classList.add('collapsed');
                    itemRows.forEach(r => r.style.display = 'none');
                } else {
                    groupRow.classList.remove('collapsed');
                    itemRows.forEach(r => r.style.display = '');
                }
            });
            if (anyExpanded) {
                btn.classList.add('collapsed');
                btn.title = 'Expand All';
            } else {
                btn.classList.remove('collapsed');
                btn.title = 'Collapse All';
            }
        }

        // ---- Mobile card group toggle ----
        function toggleMobileGroup(header) {
            const key = header.dataset.mobileGroup;
            const isCollapsed = header.classList.toggle('collapsed');
            const cards = document.querySelectorAll(`.pallet-item-mobile[data-mobile-pallet="${key}"]`);
            cards.forEach(card => {
                card.style.display = isCollapsed ? 'none' : '';
            });
        }

        function initMobileGroups() {
            // Set group counts
            document.querySelectorAll('.mobile-group-header').forEach(header => {
                const key = header.dataset.mobileGroup;
                const cards = document.querySelectorAll(`.pallet-item-mobile[data-mobile-pallet="${key}"]`);
                const countEl = header.querySelector('.group-count');
                if (countEl) {
                    countEl.textContent = `(${cards.length} item${cards.length === 1 ? '' : 's'})`;
                }
            });
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', function() {
            initPalletGroups();
            initMobileGroups();
        });

        // ---- Multi-Scan ----
        let multiScanner = null;
        const scannedItems = new Map();

        function openMultiScan() {
            document.getElementById('multiScanModal').classList.add('active');
        }
        function closeMultiScan() {
            document.getElementById('multiScanModal').classList.remove('active');
            stopMultiScanner();
        }

        async function startMultiScanner() {
            const statusEl = document.getElementById('multiScannerStatus');
            statusEl.textContent = 'Initializing camera...';
            document.getElementById('multiScanStartBtn').style.display = 'none';
            document.getElementById('multiScanStopBtn').style.display = 'inline-block';

            try {
                multiScanner = new Html5Qrcode("multi-qr-reader");
                await multiScanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => handleMultiScanResult(decodedText),
                    () => {}
                );
                statusEl.textContent = 'Scanning... Point at QR codes.';
            } catch (err) {
                statusEl.textContent = 'Camera access denied.';
                document.getElementById('multiScanStartBtn').style.display = 'inline-block';
                document.getElementById('multiScanStopBtn').style.display = 'none';
            }
        }

        async function stopMultiScanner() {
            if (multiScanner) {
                try { await multiScanner.stop(); multiScanner.clear(); } catch(e) {}
                multiScanner = null;
            }
            document.getElementById('multiScanStartBtn').style.display = 'inline-block';
            document.getElementById('multiScanStopBtn').style.display = 'none';
            document.getElementById('multiScannerStatus').textContent = 'Paused. Click scan to resume.';
        }

        function handleMultiScanResult(text) {
            if (/^\d+$/.test(text)) {
                const itemId = text;
                if (scannedItems.has('id-' + itemId)) return;

                const row = document.querySelector(`#inventoryTable tbody tr.pallet-item[data-id="${itemId}"]`);
                if (row) {
                    const mfr = row.children[1].textContent.trim();
                    const pallet = row.children[2].textContent.trim();
                    const box = row.children[4].textContent.trim();
                    const tagIdCell = row.querySelector('td:nth-child(10)');
                    const tagId = tagIdCell ? tagIdCell.textContent.trim() : '';
                    scannedItems.set('id-' + itemId, { id: itemId, mfr, pallet, box, tagId });
                    renderMultiScanList();
                }
                if (navigator.vibrate) navigator.vibrate(100);
                return;
            }

            try {
                const u = new URL(text);
                const idParam = u.searchParams.get('id');
                if (idParam) {
                    if (scannedItems.has('id-' + idParam)) return;
                    const row = document.querySelector(`#inventoryTable tbody tr.pallet-item[data-id="${idParam}"]`);
                    if (row) {
                        const mfr = row.children[1].textContent.trim();
                        const pallet = row.children[2].textContent.trim();
                        const box = row.children[4].textContent.trim();
                        const tagIdCell = row.querySelector('td:nth-child(10)');
                        const tagId = tagIdCell ? tagIdCell.textContent.trim() : '';
                        scannedItems.set('id-' + idParam, { id: idParam, mfr, pallet, box, tagId });
                        renderMultiScanList();
                    }
                    if (navigator.vibrate) navigator.vibrate(100);
                    return;
                }
            } catch(e) {}

            let dataParam = '';
            try {
                const u = new URL(text);
                dataParam = u.searchParams.get('data') || '';
            } catch(e) {
                dataParam = text;
            }
            if (!dataParam) return;

            const decoded = decodeURIComponent(dataParam);
            const parts = decoded.split(' | ');
            const dict = {};
            parts.forEach(p => {
                const [k, v] = p.split('=', 2);
                if (k && v) dict[k.trim()] = v.trim();
            });

            const mfr = dict['MFR'] || '';
            const pallet = dict['PALLET'] || '';
            const box = dict['BOX'] || '';
            const key = `${mfr}-${pallet}-${box}`;

            if (scannedItems.has(key)) return;

            const rows = document.querySelectorAll('#inventoryTable tbody tr.pallet-item');
            let itemId = null;
            let tagId = '';
            for (const row of rows) {
                if (row.dataset.search && row.dataset.search.includes(mfr.toLowerCase()) &&
                    row.dataset.pallet === `${mfr.toLowerCase()}-${pallet.toLowerCase()}`) {
                    const boxCell = row.querySelector('td:nth-child(5)');
                    if (boxCell && boxCell.textContent.trim() === '#' + box) {
                        itemId = row.dataset.id;
                        const tagIdCell = row.querySelector('td:nth-child(10)');
                        tagId = tagIdCell ? tagIdCell.textContent.trim() : '';
                        break;
                    }
                }
            }

            if (!itemId) {
                fetch(`/api/items/?mfr=${encodeURIComponent(mfr)}&pallet=${encodeURIComponent(pallet)}&box=${box}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.id) {
                            scannedItems.set(key, { id: data.id, mfr, pallet, box, tagId: `FRA-P${pallet}-B${box}` });
                            renderMultiScanList();
                        }
                    });
            } else {
                scannedItems.set(key, { id: itemId, mfr, pallet, box, tagId: tagId || `FRA-P${pallet}-B${box}` });
                renderMultiScanList();
            }

            if (navigator.vibrate) navigator.vibrate(100);
        }

        function renderMultiScanList() {
            const list = document.getElementById('multiScanList');
            const empty = document.getElementById('multiScanEmpty');
            if (empty) empty.style.display = scannedItems.size ? 'none' : 'block';

            list.querySelectorAll('.multiscan-item').forEach(el => el.remove());

            scannedItems.forEach((info, key) => {
                const div = document.createElement('div');
                div.className = 'multiscan-item';
                div.innerHTML = `
                    <div>
                        <span class="item-info">${escapeHtml(info.mfr)} - Box #${info.box}</span>
                        <span class="item-tag-id">${info.tagId}</span>
                    </div>
                    <button class="remove-btn" onclick="removeScannedItem('${key}')">Remove</button>
                `;
                list.appendChild(div);
            });

            document.getElementById('multiScanActions').style.display = scannedItems.size ? 'block' : 'none';
        }

        function removeScannedItem(key) {
            scannedItems.delete(key);
            renderMultiScanList();
        }

        async function applyMultiScanStatus() {
            const status = document.getElementById('multiScanStatus').value;
            const changedBy = document.getElementById('multiScanChangedBy').value;
            if (!status) { showToast('Select a status first', true); return; }
            if (!scannedItems.size) { showToast('No items scanned', true); return; }

            const ids = Array.from(scannedItems.values()).map(info => parseInt(info.id));

            const btn = document.getElementById('multiScanApply');
            btn.disabled = true;
            btn.textContent = 'Applying...';

            try {
                const resp = await fetch('/api/bulk-update-status/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({item_ids: ids, status: status, changed_by: changedBy, notes: 'Multi-scan bulk update'})
                });
                const data = await resp.json();
                if (data.success) {
                    showToast(`Updated ${data.updated_count} items!`);
                    scannedItems.clear();
                    closeMultiScan();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error: ' + data.error, true);
                }
            } catch(err) {
                showToast('Network error', true);
            }
            btn.disabled = false;
            btn.textContent = 'Apply Status to All';
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        // ---- Debounced search ----
        let debounceTimer = null;
        function debouncedFilter() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filterTable, 200);
        }

        // ---- Bulk edit (location, damage) ----
        async function applyBulkEdit() {
            const ids = getSelectedIds();
            if (!ids.length) return showToast('No items selected', true);

            const bulkLoc = document.getElementById('bulkLocation').value;
            const damaged = document.getElementById('bulkDamaged').value;
            const changedBy = document.getElementById('bulkChangedBy').value;

            const fields = {};
            if (bulkLoc) fields.location = bulkLoc;
            if (damaged !== '') fields.damaged = damaged === 'true';

            if (!Object.keys(fields).length) return showToast('Select a field to change', true);

            const changes = [];
            if (fields.location) changes.push('location to ' + bulkLoc);
            if ('damaged' in fields) changes.push('damage to ' + (fields.damaged ? 'Yes' : 'No'));
            if (!confirm(`Update ${ids.length} item(s): ${changes.join(', ')}?`)) return;

            try {
                const resp = await fetch('/api/bulk-edit/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({item_ids: ids, fields: fields, changed_by: changedBy})
                });
                const data = await resp.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    showToast('Error: ' + data.error, true);
                }
            } catch (err) {
                showToast('Network error', true);
            }
        }

        // ---- Dark mode ----
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
        }
        if (localStorage.getItem('darkMode') === '1') {
            document.body.classList.add('dark-mode');
        }
    </script>
</body>
</html>
