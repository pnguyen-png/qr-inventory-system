{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRATrack - Item Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #fafafa;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;
            --accent: #8b1a1a;
            --accent-light: rgba(139,26,26,0.08);
            --accent-hover: #a02020;
            --border: #d2d2d7;
            --border-light: #e8e8ed;
            --input-bg: #ffffff;
            --card-bg: #ffffff;
            --nav-bg: rgba(255,255,255,0.72);
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --green: #34c759;
            --green-bg: #f0fdf4;
            --green-text: #166534;
            --amber: #ff9f0a;
            --amber-bg: #fffbeb;
            --amber-text: #92400e;
            --red: #ff3b30;
            --red-bg: #fef2f2;
            --red-text: #991b1b;
            --purple: #af52de;
            --purple-bg: #faf5ff;
            --purple-text: #6b21a8;
            --blue: #007aff;
            --blue-bg: #eff6ff;
            --blue-text: #1e40af;
        }
        body.dark-mode {
            --bg: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #0d0d0d;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-tertiary: #6e6e73;
            --accent: #ff6b6b;
            --accent-light: rgba(255,107,107,0.1);
            --accent-hover: #ff8585;
            --border: #38383a;
            --border-light: #2c2c2e;
            --input-bg: #1c1c1e;
            --card-bg: #1c1c1e;
            --nav-bg: rgba(0,0,0,0.72);
            --shadow: 0 2px 12px rgba(0,0,0,0.3);
            --green: #30d158;
            --green-bg: #0a2613;
            --green-text: #4ade80;
            --amber: #ffd60a;
            --amber-bg: #2c2510;
            --amber-text: #fbbf24;
            --red: #ff453a;
            --red-bg: #2c1515;
            --red-text: #ff6b6b;
            --purple: #bf5af2;
            --purple-bg: #1f1528;
            --purple-text: #c084fc;
            --blue: #0a84ff;
            --blue-bg: #0d1f3c;
            --blue-text: #60a5fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* ---- Frosted glass nav ---- */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: var(--nav-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid var(--border);
            height: 48px;
            display: flex; align-items: center; justify-content: center;
            padding: 0 16px;
        }
        .nav-inner {
            max-width: 700px; width: 100%;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-brand {
            display: flex; align-items: center; gap: 10px; text-decoration: none;
        }
        .nav-logo {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #8b1a1a 0%, #b82e2e 100%);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 0.65rem;
        }
        body.dark-mode .nav-logo {
            background: linear-gradient(135deg, #ff6b6b 0%, #8b1a1a 100%);
        }
        .nav-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em; }
        .nav-right { display: flex; align-items: center; gap: 12px; }
        .dark-toggle-btn {
            background: none; border: none; color: var(--text-tertiary); cursor: pointer;
            display: flex; align-items: center; padding: 4px; transition: color 0.2s;
        }
        .dark-toggle-btn:hover { color: var(--text-primary); }
        .nav-back {
            font-size: 0.8rem; color: var(--text-secondary); text-decoration: none;
            font-weight: 500; transition: color 0.2s;
        }
        .nav-back:hover { color: var(--text-primary); }

        /* ---- Main content ---- */
        .container { max-width: 700px; margin: 0 auto; padding: 64px 16px 40px; }

        /* ---- Error card ---- */
        .error-card {
            background: var(--red-bg); border: 0.5px solid var(--red);
            border-radius: 14px; padding: 40px 24px;
            text-align: center;
        }
        .error-card h2 { color: var(--red-text); font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.02em; }
        .error-card p { color: var(--red-text); font-size: 0.875rem; opacity: 0.8; }

        /* ---- Item card ---- */
        .item-card {
            background: var(--card-bg); border: 0.5px solid var(--border-light);
            border-radius: 14px; overflow: hidden;
            box-shadow: var(--shadow);
        }
        .item-card-header {
            padding: 20px 24px;
            border-bottom: 0.5px solid var(--border-light);
        }
        .item-card-header-inner {
            display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;
        }
        .item-card-header h2 {
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary);
            letter-spacing: -0.02em; margin-bottom: 2px;
        }
        .item-card-header .subtitle {
            font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;
        }
        .item-card-header-right {
            text-align: right; flex-shrink: 0;
        }

        /* ---- Tabs ---- */
        .tab-bar {
            display: flex; border-bottom: 1.5px solid var(--border-light);
            background: var(--card-bg);
        }
        .tab-btn {
            flex: 1; padding: 14px 16px; font-size: 0.8rem; font-weight: 600;
            color: var(--text-tertiary); background: none; border: none;
            cursor: pointer; font-family: inherit; transition: all 0.2s;
            border-bottom: 2.5px solid transparent; margin-bottom: -1.5px;
            letter-spacing: -0.01em;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active {
            color: var(--accent); border-bottom-color: var(--accent);
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ---- Status badges ---- */
        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 999px;
            font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .status-checked_in { background: var(--green-bg); color: var(--green-text); }
        .status-checked_out { background: var(--amber-bg); color: var(--amber-text); }
        .status-tested { background: var(--blue-bg); color: var(--blue-text); }
        .status-will_be_reused { background: var(--purple-bg); color: var(--purple-text); }
        .status-recycling { background: var(--red-bg); color: var(--red-text); }

        /* ---- Scan count ---- */
        .scan-count {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; background: var(--bg-secondary); border-radius: 999px;
            font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px;
            font-weight: 500;
        }

        /* ---- Overdue alert ---- */
        .overdue-alert {
            background: var(--amber-bg); border: 0.5px solid var(--amber); border-radius: 10px;
            padding: 10px 16px; margin: 16px 20px 0; font-size: 0.8rem; color: var(--amber-text);
            font-weight: 500;
        }

        /* ---- Detail grid ---- */
        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 0; border-top: 0.5px solid var(--border-light);
        }
        .detail-cell {
            padding: 14px 20px;
            border-bottom: 0.5px solid var(--border-light);
        }
        .detail-cell:nth-child(odd) {
            border-right: 0.5px solid var(--border-light);
        }
        .detail-cell label {
            display: block; font-size: 0.65rem; text-transform: uppercase;
            letter-spacing: 0.06em; color: var(--text-tertiary); margin-bottom: 4px;
            font-weight: 600;
        }
        .detail-cell .value {
            font-size: 0.9rem; font-weight: 500; color: var(--text-primary);
        }
        .damage-yes { color: var(--red-text); font-weight: 700; }
        .damage-no { color: var(--green-text); }

        /* ---- Description section ---- */
        .description-section {
            padding: 16px 20px; border-top: 0.5px solid var(--border-light);
        }
        .description-section label {
            display: block; font-size: 0.65rem; text-transform: uppercase;
            letter-spacing: 0.06em; color: var(--text-tertiary); margin-bottom: 6px;
            font-weight: 600;
        }
        .description-section p {
            font-size: 0.9rem; line-height: 1.5; color: var(--text-primary);
        }

        /* ---- Tags ---- */
        .tag-display-chip {
            display: inline-block; padding: 4px 12px; border-radius: 999px;
            font-size: 0.7rem; font-weight: 600;
            background: var(--accent-light); color: var(--accent);
        }

        /* ---- QR Code ---- */
        .qr-section {
            padding: 20px; border-top: 0.5px solid var(--border-light); text-align: center;
        }
        .qr-section h3 {
            font-size: 0.8rem; font-weight: 600; margin-bottom: 12px;
            color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em;
        }
        .qr-code-img {
            border: 0.5px solid var(--border-light); border-radius: 10px; padding: 8px;
            background: var(--card-bg); cursor: pointer;
            max-width: 100%; height: auto; transition: border-color 0.2s;
        }
        .qr-code-img:hover { border-color: var(--accent); }
        .qr-caption {
            margin-top: 8px; font-size: 0.8rem; font-weight: 500;
            color: var(--text-secondary); line-height: 1.5;
        }

        /* ---- Photos section ---- */
        .photos-section {
            padding: 20px; border-top: 0.5px solid var(--border-light);
        }
        .photos-section h3 {
            font-size: 0.8rem; font-weight: 600; margin-bottom: 12px;
            color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em;
        }
        .photos-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px; margin-bottom: 16px;
        }
        .photo-card {
            position: relative; border-radius: 10px; overflow: hidden;
            border: 0.5px solid var(--border-light); aspect-ratio: 1;
            transition: border-color 0.2s;
        }
        .photo-card:hover { border-color: var(--border); }
        .photo-card img {
            width: 100%; height: 100%; object-fit: cover; cursor: pointer;
        }
        .photo-card .photo-delete {
            position: absolute; top: 6px; right: 6px; background: rgba(255,59,48,0.9);
            color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; backdrop-filter: blur(4px);
        }
        .photo-card .photo-delete:hover { background: var(--red); }
        .photo-card .photo-caption {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.6); color: #fff; padding: 4px 8px;
            font-size: 0.65rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            backdrop-filter: blur(4px);
        }
        .photo-upload-inline {
            border: 1.5px dashed var(--border); border-radius: 10px; padding: 20px;
            text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s;
        }
        .photo-upload-inline:hover { border-color: var(--accent); background: var(--accent-light); }
        .photo-upload-inline p { color: var(--text-tertiary); font-size: 0.8rem; font-weight: 500; }
        .photo-upload-inline .icon { font-size: 1.5rem; margin-bottom: 4px; }
        .upload-progress {
            margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary); display: none;
            font-weight: 500;
        }
        .no-photos-msg { color: var(--text-tertiary); font-size: 0.8rem; grid-column: 1 / -1; }

        /* ---- Edit section ---- */
        .edit-section {
            padding: 20px; border-top: 0.5px solid var(--border-light);
        }
        .edit-section h3 {
            font-size: 0.85rem; font-weight: 700; margin-bottom: 16px;
            color: var(--text-primary); letter-spacing: -0.01em;
        }
        .edit-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;
        }
        .edit-group label {
            display: block; font-size: 0.65rem; text-transform: uppercase;
            letter-spacing: 0.06em; color: var(--text-tertiary); margin-bottom: 4px;
            font-weight: 600;
        }
        .edit-group label span {
            text-transform: none; letter-spacing: normal; font-weight: 400;
        }
        .edit-input {
            width: 100%; padding: 9px 12px; border: 0.5px solid var(--border);
            border-radius: 10px; font-size: 0.85rem; font-family: inherit;
            background: var(--input-bg); color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .edit-input:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        textarea.edit-input { resize: vertical; min-height: 50px; }

        /* ---- Tag chips (edit mode) ---- */
        .tag-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip {
            display: inline-block; padding: 6px 14px; border-radius: 999px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            background: var(--bg-secondary); color: var(--text-secondary);
            border: 0.5px solid var(--border-light);
            transition: all 0.2s; user-select: none;
        }
        .tag-chip:hover { border-color: var(--accent); color: var(--accent); }
        .tag-chip.active {
            background: var(--accent-light); color: var(--accent);
            border-color: var(--accent);
        }
        .tag-chip .remove-tag {
            margin-left: 6px; font-weight: 700; font-size: 0.9rem;
        }
        .custom-tag-row {
            display: flex; gap: 8px; margin-top: 8px;
        }
        .btn-add-tag {
            padding: 7px 14px; background: var(--accent); color: #fff;
            border: none; border-radius: 10px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; white-space: nowrap; transition: background 0.2s;
        }
        .btn-add-tag:hover { background: var(--accent-hover); }

        .tag-bank-toggle {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 12px; border-radius: 999px; font-size: 0.78rem;
            font-weight: 500; cursor: pointer; background: transparent;
            color: var(--text-tertiary); border: 1px dashed var(--border-light);
            transition: all 0.15s; user-select: none; font-family: inherit;
        }
        .tag-bank-toggle:hover { border-color: var(--accent); color: var(--accent); }
        .tag-bank-toggle .arrow { font-size: 0.65rem; transition: transform 0.2s; }
        .tag-bank-toggle.open .arrow { transform: rotate(180deg); }
        .tag-bank { display: none; margin-top: 8px; }
        .tag-bank.open { display: flex; flex-wrap: wrap; gap: 8px; }

        /* ---- Status divider ---- */
        .status-divider {
            border-top: 0.5px solid var(--border-light); margin-top: 16px; padding-top: 16px;
        }

        /* ---- Buttons ---- */
        .btn-save-edit {
            padding: 11px 28px; background: var(--accent); color: #fff; border: none;
            border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            transition: background 0.2s; margin-top: 12px;
        }
        .btn-save-edit:hover { background: var(--accent-hover); }
        .btn-save-edit:disabled { opacity: 0.4; cursor: not-allowed; }

        .edit-message {
            margin-top: 10px; padding: 10px 14px; border-radius: 10px;
            font-size: 0.8rem; display: none; font-weight: 500;
        }
        .edit-message.success { display: block; background: var(--green-bg); color: var(--green-text); }
        .edit-message.error { display: block; background: var(--red-bg); color: var(--red-text); }

        /* ---- Archive bar ---- */
        .archive-bar {
            padding: 14px 20px; border-top: 0.5px solid var(--border-light);
            display: flex; align-items: center; justify-content: space-between;
        }
        .archive-bar span { font-size: 0.8rem; color: var(--text-tertiary); }
        .btn-archive {
            padding: 8px 16px; border: 0.5px solid var(--border); border-radius: 10px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            background: var(--bg-secondary); color: var(--text-secondary);
            transition: all 0.2s;
        }
        .btn-archive:hover { background: var(--border-light); }
        .btn-archive.active { background: var(--amber); color: #fff; border-color: var(--amber); }

        /* ---- Last updated ---- */
        .last-updated {
            padding: 12px 20px; border-top: 0.5px solid var(--border-light);
            font-size: 0.7rem; color: var(--text-tertiary); text-align: right;
            font-weight: 500;
        }

        /* ---- Location custom wrap ---- */
        .location-custom-wrap { margin-top: 8px; display: none; }

        /* ---- Event Log ---- */
        .log-entry {
            padding: 14px 20px; border-bottom: 0.5px solid var(--border-light);
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry-top {
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
        }
        .log-arrow { color: var(--text-tertiary); font-size: 0.8rem; }
        .log-date { color: var(--text-tertiary); font-size: 0.7rem; margin-left: auto; font-weight: 500; }
        .log-changed-by { font-size: 0.7rem; color: var(--purple); font-weight: 600; }
        .log-notes {
            margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);
            line-height: 1.5;
        }
        .log-notes-empty {
            margin-top: 6px; font-size: 0.75rem; color: var(--text-tertiary); font-style: italic;
        }
        .log-notes-edit {
            margin-top: 8px; display: flex; gap: 8px; align-items: flex-start;
        }
        .log-notes-input {
            flex: 1; padding: 7px 10px; border: 0.5px solid var(--border);
            border-radius: 8px; font-size: 0.8rem; font-family: inherit;
            resize: vertical; min-height: 32px; background: var(--input-bg);
            color: var(--text-primary);
        }
        .log-notes-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .btn-save-note {
            padding: 7px 14px; background: var(--blue); color: #fff;
            border: none; border-radius: 8px; font-size: 0.7rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: opacity 0.2s;
        }
        .btn-save-note:hover { opacity: 0.85; }
        .btn-edit-note {
            padding: 4px 10px; background: var(--bg-secondary); color: var(--text-secondary);
            border: 0.5px solid var(--border-light); border-radius: 6px; font-size: 0.65rem;
            cursor: pointer; margin-left: 8px; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-edit-note:hover { background: var(--border-light); color: var(--text-primary); }
        .log-empty {
            padding: 30px 20px; text-align: center; color: var(--text-tertiary); font-size: 0.85rem;
        }

        /* ---- Field change log ---- */
        .log-field-change {
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
        }
        .log-field-name {
            font-size: 0.65rem; font-weight: 700; color: var(--text-primary);
            text-transform: uppercase; letter-spacing: 0.04em;
            background: var(--bg-secondary); padding: 2px 8px; border-radius: 6px;
        }
        .log-old-value {
            font-size: 0.8rem; color: var(--text-tertiary); text-decoration: line-through;
        }
        .log-new-value {
            font-size: 0.8rem; color: var(--green-text); font-weight: 600;
        }
        .log-type-badge {
            font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.06em; padding: 2px 8px; border-radius: 6px;
        }
        .log-type-status { background: var(--blue-bg); color: var(--blue-text); }
        .log-type-field { background: var(--amber-bg); color: var(--amber-text); }
        .log-type-created { background: var(--green-bg); color: var(--green-text); }

        /* ---- Nav links ---- */
        .nav-links { margin-top: 20px; text-align: center; }
        .nav-links a {
            color: var(--accent); text-decoration: none; font-size: 0.8rem;
            margin: 0 12px; font-weight: 600; transition: color 0.2s;
        }
        .nav-links a:hover { color: var(--accent-hover); }

        /* ---- Responsive ---- */
        @media (max-width: 600px) {
            .detail-grid { grid-template-columns: 1fr; }
            .detail-cell:nth-child(odd) { border-right: none; }
            .edit-row { grid-template-columns: 1fr; }
            .item-card-header-inner { flex-direction: column; gap: 8px; }
            .item-card-header-right { text-align: left; }
            .btn-save-edit { width: 100%; text-align: center; }
            .archive-bar { flex-direction: column; gap: 10px; align-items: flex-start; }
            .photos-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div style="display:none">{% csrf_token %}</div>
    <nav class="nav">
        <div class="nav-inner">
            <a href="/dashboard/" class="nav-brand">
                <div class="nav-logo">FR</div>
                <span class="nav-title">FRATrack</span>
            </a>
            <div class="nav-right">
                <a href="/dashboard/" class="nav-back">Dashboard</a>
                <button class="dark-toggle-btn" onclick="toggleDarkMode()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        {% if error %}
        <div class="error-card">
            <h2>Item Not Found</h2>
            <p>{{ error }}</p>
        </div>
        <div class="nav-links">
            <a href="/dashboard/">Browse All Inventory</a>
        </div>

        {% elif item %}
        <div class="item-card">
            <!-- Tab bar -->
            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab('details', this)">Details</button>
                <button class="tab-btn" onclick="switchTab('eventlog', this)">Event Log</button>
            </div>

            <div class="tab-panel active" id="tabDetails">
            <div class="item-card-header">
                <div class="item-card-header-inner">
                    <div>
                        <h2>{{ item.manufacturer }} - Box {{ item.box_id }}</h2>
                        <div class="subtitle">Pallet: {{ item.pallet_id }}</div>
                    </div>
                    <div class="item-card-header-right">
                        <span class="status-badge status-{{ item.status }}" id="statusBadge">
                            {{ item.get_status_display }}
                        </span>
                        {% if scan_count %}
                        <div class="scan-count">Scanned {{ scan_count }} time{{ scan_count|pluralize }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if item.is_overdue %}
            <div class="overdue-alert">
                <strong>Overdue!</strong> This item has been checked out for {{ item.days_checked_out }} days
                {% if item.checked_out_by %} by {{ item.checked_out_by }}{% endif %}.
            </div>
            {% endif %}

            <div class="detail-grid">
                <div class="detail-cell">
                    <label>Manufacturer / Supplier</label>
                    <div class="value">{{ item.manufacturer }}</div>
                </div>
                <div class="detail-cell">
                    <label>Pallet ID</label>
                    <div class="value">{{ item.pallet_id }}</div>
                </div>
                <div class="detail-cell">
                    <label>Box ID</label>
                    <div class="value">#{{ item.box_id }}</div>
                </div>
                <div class="detail-cell">
                    <label>Tag ID</label>
                    <div class="value" style="font-weight:700; color:var(--accent);">{{ item.tag_id }}</div>
                </div>
                <div class="detail-cell">
                    <label>Contents (qty)</label>
                    <div class="value">{{ item.content }}</div>
                </div>
                <div class="detail-cell">
                    <label>Project Number</label>
                    <div class="value">{{ item.project_number|default:"-" }}</div>
                </div>
                <div class="detail-cell">
                    <label>Receiving Location</label>
                    <div class="value">{{ item.location }}</div>
                </div>
                <div class="detail-cell">
                    <label>Damage Reported</label>
                    <div class="value {% if item.damaged %}damage-yes{% else %}damage-no{% endif %}">
                        {{ item.get_damaged_display }}
                    </div>
                </div>
                {% if item.checked_out_by %}
                <div class="detail-cell">
                    <label>Checked Out By</label>
                    <div class="value">{{ item.checked_out_by }}</div>
                </div>
                <div class="detail-cell">
                    <label>Checked Out Since</label>
                    <div class="value">{{ item.checked_out_at|date:"M d, Y H:i" }}</div>
                </div>
                {% endif %}
            </div>

            {% if item.description %}
            <div class="description-section">
                <label>Brief Description of Shipment</label>
                <p>{{ item.description }}</p>
            </div>
            {% endif %}

            {% if item.tags %}
            <div class="description-section">
                <label>Tags</label>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
                    {% for tag in item.tags_list %}
                    <span class="tag-display-chip">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="qr-section">
                <h3>QR Code</h3>
                <img class="qr-code-img" src="{{ item.short_qr_url }}" alt="QR Code for {{ item.manufacturer }} Box #{{ item.box_id }}">
                <div class="qr-caption">
                    {{ item.manufacturer }}<br>
                    Pallet {{ item.pallet_id }} &bull; Box #{{ item.box_id }}
                </div>
            </div>

            <!-- Photos -->
            <div class="photos-section">
                <h3>Photos</h3>
                <div class="photos-grid" id="photosGrid">
                    {% for photo in photos %}
                    <div class="photo-card" id="photo-{{ photo.id }}">
                        <img src="{{ photo.image.url }}" alt="{{ photo.caption }}"
                             onclick="window.open('{{ photo.image.url }}', '_blank')">
                        <button class="photo-delete" onclick="deletePhoto({{ photo.id }})" title="Delete photo">&times;</button>
                        {% if photo.caption %}<div class="photo-caption">{{ photo.caption }}</div>{% endif %}
                    </div>
                    {% empty %}
                    <p class="no-photos-msg">No photos yet.</p>
                    {% endfor %}
                </div>
                <div class="photo-upload-inline" onclick="document.getElementById('itemPhotoInput').click();">
                    <div class="icon">&#128247;</div>
                    <p>Click to upload a photo</p>
                </div>
                <input type="file" id="itemPhotoInput" accept="image/*" style="display:none;" onchange="uploadItemPhoto({{ item.id }})">
                <div class="upload-progress" id="uploadProgress">Uploading...</div>
            </div>

            <div class="edit-section">
                <h3>Edit Details &amp; Update Status</h3>
                <div class="edit-row">
                    <div class="edit-group">
                        <label>Contents (Qty)</label>
                        <input type="number" class="edit-input" id="editContent" value="{{ item.content }}" min="0">
                    </div>
                    <div class="edit-group">
                        <label>Damage Reported</label>
                        <select class="edit-input" id="editDamaged">
                            <option value="false" {% if not item.damaged %}selected{% endif %}>No</option>
                            <option value="true" {% if item.damaged %}selected{% endif %}>Yes</option>
                        </select>
                    </div>
                </div>
                <div class="edit-row">
                    <div class="edit-group">
                        <label>Receiving Location</label>
                        <select class="edit-input" id="editLocationSelect" onchange="toggleEditCustomLocation()">
                            {% for loc in location_choices %}
                            <option value="{{ loc }}" {% if item.location == loc %}selected{% endif %}>{{ loc }}</option>
                            {% endfor %}
                            <option value="other" {% if item.location not in location_choices %}selected{% endif %}>Other</option>
                        </select>
                        <div class="location-custom-wrap" id="editCustomLocationWrap">
                            <input type="text" class="edit-input" id="editLocationCustom"
                                value="{% if item.location not in location_choices %}{{ item.location }}{% endif %}"
                                placeholder="Enter custom location">
                        </div>
                        <input type="hidden" id="editLocation" value="{{ item.location }}">
                    </div>
                    <div class="edit-group">
                        <label>Description</label>
                        <input type="text" class="edit-input" id="editDescription" value="{{ item.description }}">
                    </div>
                </div>
                <div class="edit-row">
                    <div class="edit-group">
                        <label>Project Number</label>
                        <input type="text" class="edit-input" id="editProjectNumber" value="{{ item.project_number }}">
                    </div>
                    <div class="edit-group">
                        <label>Manufacturer / Supplier</label>
                        <input type="text" class="edit-input" id="editManufacturer" value="{{ item.manufacturer }}">
                    </div>
                </div>

                <!-- Tags -->
                <div class="edit-group" style="margin-top:12px;">
                    <label>Tags / Keywords</label>
                    <div class="tag-chips" id="tagChips">
                        {% for tag in assigned_tags %}
                        <span class="tag-chip active" data-tag="{{ tag }}" onclick="toggleTag(this)">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% if more_tags %}
                    <div style="margin-top: 10px;">
                        <button type="button" class="tag-bank-toggle" onclick="toggleTagBank(this)">
                            More tags <span class="arrow">&#9660;</span>
                        </button>
                        <div class="tag-bank" id="tagBank">
                            {% for tag in more_tags %}
                            <span class="tag-chip" data-tag="{{ tag }}" onclick="toggleTag(this)">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="custom-tag-row">
                        <input type="text" class="edit-input" id="customTagInput" placeholder="Add custom tag..." style="flex:1;">
                        <button type="button" class="btn-add-tag" onclick="addCustomTag()">Add</button>
                    </div>
                    <input type="hidden" id="tagsHidden" value="{{ item.tags }}">
                </div>

                <!-- Status Update (integrated into Edit Details) -->
                <div class="status-divider">
                    <label style="display:block; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.06em; color:var(--text-tertiary); margin-bottom:6px; font-weight:600;">Status</label>
                    <select class="edit-input" id="editStatus" style="margin-bottom:12px;">
                        <option value="checked_in" {% if item.status == 'checked_in' %}selected{% endif %}>Checked In</option>
                        <option value="checked_out" {% if item.status == 'checked_out' %}selected{% endif %}>Checked Out</option>
                        <option value="tested" {% if item.status == 'tested' %}selected{% endif %}>Tested</option>
                        <option value="will_be_reused" {% if item.status == 'will_be_reused' %}selected{% endif %}>Will Be Reused</option>
                        <option value="recycling" {% if item.status == 'recycling' %}selected{% endif %}>Recycling</option>
                    </select>
                    <div class="edit-row">
                        <div class="edit-group">
                            <label>Your Name <span>(optional, for event log)</span></label>
                            <input type="text" class="edit-input" id="changedByInput" placeholder="Your name">
                        </div>
                        <div class="edit-group">
                            <label>Notes <span>(optional)</span></label>
                            <input type="text" class="edit-input" id="statusNotes" placeholder="Add notes...">
                        </div>
                    </div>
                </div>

                <button class="btn-save-edit" id="btnSaveEdit" onclick="saveEdit({{ item.id }})">Save Changes</button>
                <div class="edit-message" id="editMessage"></div>
            </div>

            <!-- Archive -->
            <div class="archive-bar">
                <span>
                    {% if item.archived %}This item is archived.{% else %}Move to archive when no longer needed.{% endif %}
                </span>
                <button class="btn-archive {% if item.archived %}active{% endif %}" id="archiveBtn"
                    onclick="toggleArchive({{ item.id }}, {{ item.archived|yesno:'false,true' }})">
                    {% if item.archived %}Unarchive{% else %}Archive Item{% endif %}
                </button>
            </div>

            <div class="last-updated" id="lastUpdated">
                Last updated: {{ item.updated_at|date:"M d, Y H:i" }}
            </div>
            </div><!-- /tabDetails -->

            <!-- Event Log tab -->
            <div class="tab-panel" id="tabEventLog">
            <div id="historyLog">
                {% for entry in audit_trail %}
                <div class="log-entry">
                    {% if entry.entry_type == 'status' %}
                    {# Status change entry #}
                    <div class="log-entry-top">
                        <span class="log-type-badge log-type-status">Status</span>
                        {% if entry.old_status %}
                        <span class="status-badge status-{{ entry.old_status }}">{{ entry.old_status_label }}</span>
                        <span class="log-arrow">&rarr;</span>
                        {% endif %}
                        <span class="status-badge status-{{ entry.new_status }}">{{ entry.new_status_label }}</span>
                        {% if entry.changed_by %}<span class="log-changed-by">by {{ entry.changed_by }}</span>{% endif %}
                        <span class="log-date">{{ entry.changed_at|date:"M d, Y H:i:s" }}</span>
                    </div>
                    {% if entry.notes %}
                    <div class="log-notes">{{ entry.notes }}</div>
                    {% endif %}

                    {% elif entry.entry_type == 'change' %}
                    {# Field change or creation entry #}
                    <div class="log-entry-top">
                        {% if entry.change_type == 'created' %}
                        <span class="log-type-badge log-type-created">Created</span>
                        <span style="font-size:0.8rem; color:var(--text-secondary);">Item checked in</span>
                        {% else %}
                        <span class="log-type-badge log-type-field">Edit</span>
                        <div class="log-field-change">
                            <span class="log-field-name">{{ entry.field_label }}</span>
                            {% if entry.old_value %}
                            <span class="log-old-value">{{ entry.old_value }}</span>
                            <span class="log-arrow">&rarr;</span>
                            {% endif %}
                            <span class="log-new-value">{{ entry.new_value }}</span>
                        </div>
                        {% endif %}
                        {% if entry.changed_by %}<span class="log-changed-by">by {{ entry.changed_by }}</span>{% endif %}
                        <span class="log-date">{{ entry.changed_at|date:"M d, Y H:i:s" }}</span>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="log-empty">No changes recorded yet.</div>
                {% endfor %}
            </div>
            </div><!-- /tabEventLog -->
        </div><!-- /item-card -->

        <div class="nav-links">
            <a href="/dashboard/">View Full Inventory</a>
        </div>
        {% endif %}
    </div>

    {% if item %}
    <script>
        // ---- CSRF token helper ----
        function getCookie(name) {
            let v = null;
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach(function(c) {
                    c = c.trim();
                    if (c.substring(0, name.length + 1) === (name + '='))
                        v = decodeURIComponent(c.substring(name.length + 1));
                });
            }
            return v;
        }

        // ---- Tab switching ----
        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (tab === 'details') document.getElementById('tabDetails').classList.add('active');
            else if (tab === 'eventlog') document.getElementById('tabEventLog').classList.add('active');
        }

        const STATUS_MAP = {
            'Checked In': 'checked_in',
            'Checked Out': 'checked_out',
            'Tested': 'tested',
            'Will Be Reused': 'will_be_reused',
            'Recycling': 'recycling'
        };

        function addLogEntry(data, notes, changedBy) {
            const log = document.getElementById('historyLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const newKey = STATUS_MAP[data.status] || 'checked_in';

            const now = new Date().toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            const notesHtml = notes
                ? `<div class="log-notes">${escapeHtml(notes)}</div>`
                : `<div class="log-notes-empty">No notes</div>`;

            const byHtml = changedBy
                ? `<span class="log-changed-by">by ${escapeHtml(changedBy)}</span>`
                : '';

            entry.innerHTML = `
                <div class="log-entry-top">
                    <span class="status-badge status-${newKey}">${escapeHtml(data.status)}</span>
                    ${byHtml}
                    <span class="log-date">${now} (just now)</span>
                </div>
                ${notesHtml}
            `;
            log.insertBefore(entry, log.firstChild);
        }

        function showEditNotes(historyId) {
            document.getElementById('notes-display-' + historyId).style.display = 'none';
            document.getElementById('notes-edit-' + historyId).style.display = 'flex';
            document.getElementById('notes-input-' + historyId).focus();
        }

        async function saveNotes(historyId) {
            const input = document.getElementById('notes-input-' + historyId);
            const notes = input.value;

            try {
                const formData = new FormData();
                formData.append('history_id', historyId);
                formData.append('notes', notes);

                const resp = await fetch('/api/update-notes/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')},
                    body: formData
                });

                const data = await resp.json();

                if (data.success) {
                    const display = document.getElementById('notes-display-' + historyId);
                    if (notes) {
                        display.innerHTML = `<div class="log-notes">${escapeHtml(notes)} <button class="btn-edit-note" onclick="showEditNotes(${historyId})">Edit</button></div>`;
                    } else {
                        display.innerHTML = `<div class="log-notes-empty">No notes <button class="btn-edit-note" onclick="showEditNotes(${historyId})">Add</button></div>`;
                    }
                    display.style.display = 'block';
                    document.getElementById('notes-edit-' + historyId).style.display = 'none';
                }
            } catch (err) {
                alert('Failed to save notes. Please try again.');
            }
        }

        // ---- Location dropdown ----
        function toggleEditCustomLocation() {
            const sel = document.getElementById('editLocationSelect');
            const wrap = document.getElementById('editCustomLocationWrap');
            const hidden = document.getElementById('editLocation');
            if (sel.value === 'other') {
                wrap.style.display = 'block';
                hidden.value = document.getElementById('editLocationCustom').value;
            } else {
                wrap.style.display = 'none';
                hidden.value = sel.value;
            }
        }
        // Update hidden field when custom input changes
        document.addEventListener('DOMContentLoaded', function() {
            toggleEditCustomLocation();
            const customInput = document.getElementById('editLocationCustom');
            if (customInput) {
                customInput.addEventListener('input', function() {
                    document.getElementById('editLocation').value = this.value;
                });
            }
        });

        // ---- Photo upload ----
        async function uploadItemPhoto(itemId) {
            const input = document.getElementById('itemPhotoInput');
            const progress = document.getElementById('uploadProgress');
            if (!input.files.length) return;

            progress.style.display = 'block';
            progress.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('item_id', itemId);
            formData.append('photo', input.files[0]);
            formData.append('caption', '');

            try {
                const resp = await fetch('/api/upload-photo/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')},
                    body: formData
                });
                const data = await resp.json();
                if (data.success) {
                    // Add photo to grid
                    const grid = document.getElementById('photosGrid');
                    const emptyMsg = grid.querySelector('p');
                    if (emptyMsg) emptyMsg.remove();

                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    card.id = 'photo-' + data.photo_id;
                    card.innerHTML = `
                        <img src="${data.photo_url}" alt="Photo" onclick="window.open('${data.photo_url}', '_blank')">
                        <button class="photo-delete" onclick="deletePhoto(${data.photo_id})" title="Delete photo">&times;</button>
                    `;
                    grid.appendChild(card);
                    progress.textContent = 'Photo uploaded!';
                    setTimeout(() => { progress.style.display = 'none'; }, 2000);
                } else {
                    progress.textContent = 'Error: ' + (data.error || 'Upload failed');
                }
            } catch (err) {
                progress.textContent = 'Network error. Please try again.';
            }
            input.value = '';
        }

        async function deletePhoto(photoId) {
            if (!confirm('Delete this photo?')) return;
            try {
                const resp = await fetch('/api/delete-photo/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                    body: JSON.stringify({photo_id: photoId})
                });
                const data = await resp.json();
                if (data.success) {
                    const card = document.getElementById('photo-' + photoId);
                    if (card) card.remove();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Network error.');
            }
        }

        // ---- Tag bank toggle ----
        function toggleTagBank(btn) {
            btn.classList.toggle('open');
            var bank = document.getElementById('tagBank');
            if (bank) bank.classList.toggle('open');
        }

        // ---- Tag management ----
        function getSelectedTags() {
            return Array.from(document.querySelectorAll('.tag-chip.active')).map(c => c.dataset.tag);
        }
        function updateTagsHidden() {
            document.getElementById('tagsHidden').value = getSelectedTags().join(',');
        }
        function toggleTag(chip) {
            chip.classList.toggle('active');
            updateTagsHidden();
        }
        function addCustomTag() {
            const input = document.getElementById('customTagInput');
            const val = input.value.trim();
            if (!val) return;
            const existing = document.querySelector(`.tag-chip[data-tag="${val}"]`);
            if (existing) { existing.classList.add('active'); updateTagsHidden(); input.value = ''; return; }
            const chip = document.createElement('span');
            chip.className = 'tag-chip active';
            chip.dataset.tag = val;
            chip.textContent = val;
            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove-tag';
            removeBtn.textContent = '\u00D7';
            removeBtn.onclick = function(e) { e.stopPropagation(); chip.remove(); updateTagsHidden(); };
            chip.appendChild(removeBtn);
            chip.onclick = function() { toggleTag(this); };
            document.getElementById('tagChips').appendChild(chip);
            updateTagsHidden();
            input.value = '';
        }
        document.getElementById('customTagInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); addCustomTag(); }
        });

        // Initialize tags from item's current tags
        (function() {
            const savedTags = document.getElementById('tagsHidden').value;
            if (savedTags) {
                const presetNames = Array.from(document.querySelectorAll('.tag-chip')).map(c => c.dataset.tag);
                savedTags.split(',').forEach(t => {
                    t = t.trim();
                    if (!t) return;
                    const chip = document.querySelector(`.tag-chip[data-tag="${t}"]`);
                    if (chip) { chip.classList.add('active'); }
                    else {
                        // Custom tag - add it
                        const c = document.createElement('span');
                        c.className = 'tag-chip active';
                        c.dataset.tag = t;
                        c.textContent = t;
                        const rb = document.createElement('span');
                        rb.className = 'remove-tag';
                        rb.textContent = '\u00D7';
                        rb.onclick = function(e) { e.stopPropagation(); c.remove(); updateTagsHidden(); };
                        c.appendChild(rb);
                        c.onclick = function() { toggleTag(this); };
                        document.getElementById('tagChips').appendChild(c);
                    }
                });
            }
        })();

        // ---- Edit Details (with integrated status update) ----
        async function saveEdit(itemId) {
            const btn = document.getElementById('btnSaveEdit');
            const msgEl = document.getElementById('editMessage');
            btn.disabled = true;
            msgEl.className = 'edit-message';
            msgEl.style.display = 'none';

            // Update location from dropdown
            const locSel = document.getElementById('editLocationSelect');
            if (locSel) {
                if (locSel.value === 'other') {
                    document.getElementById('editLocation').value = document.getElementById('editLocationCustom').value;
                } else {
                    document.getElementById('editLocation').value = locSel.value;
                }
            }

            // Update tags hidden input
            updateTagsHidden();

            const payload = {
                item_id: itemId,
                content: parseInt(document.getElementById('editContent').value),
                damaged: document.getElementById('editDamaged').value === 'true',
                location: document.getElementById('editLocation').value,
                description: document.getElementById('editDescription').value,
                project_number: document.getElementById('editProjectNumber').value,
                manufacturer: document.getElementById('editManufacturer').value,
                tags: document.getElementById('tagsHidden').value,
                status: document.getElementById('editStatus').value,
                changed_by: document.getElementById('changedByInput').value,
                notes: document.getElementById('statusNotes').value,
            };

            try {
                const resp = await fetch('/api/edit-item/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    // Reload the page to show the saved data from the database
                    location.reload();
                    return;
                } else {
                    msgEl.textContent = 'Error: ' + (data.error || 'Save failed. Please check your input.');
                    msgEl.className = 'edit-message error';
                }
            } catch (err) {
                msgEl.textContent = 'Network error. Please try again.';
                msgEl.className = 'edit-message error';
            }
            btn.disabled = false;
        }

        // ---- Archive ----
        async function toggleArchive(itemId, archive) {
            try {
                const resp = await fetch('/api/archive-item/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                    body: JSON.stringify({item_id: itemId, archive: archive})
                });
                const data = await resp.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Network error.');
            }
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    </script>
    {% endif %}

    {% if item %}
    {% endif %}
    <script>
    // Dark mode toggle
    function toggleDarkMode() {
        var isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark ? '1' : '0');
    }
    if (localStorage.getItem('darkMode') === '1') {
        document.body.classList.add('dark-mode');
    }
    </script>
</body>
</html>
