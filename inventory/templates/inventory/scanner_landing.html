{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire &amp; Risk Alliance - Inventory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f0eb;
            color: #1a1a2e;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d1518 100%);
            color: #fff;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #b8860b;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-brand img {
            height: 44px;
            width: auto;
            border-radius: 4px;
        }
        .header-brand-text h1 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
        }
        .header-brand-text .subtitle {
            font-size: 0.7rem;
            color: #b8860b;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .header a { color: #d4a84b; text-decoration: none; font-size: 0.875rem; font-weight: 500; }
        .header a:hover { color: #fff; }
        .container { max-width: 700px; margin: 24px auto; padding: 0 16px; }

        .error-card {
            background: #fff; border-radius: 12px; padding: 40px 24px;
            text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .error-card h2 { color: #dc2626; margin-bottom: 8px; }
        .error-card p { color: #64748b; }

        .item-card {
            background: #fff; border-radius: 12px; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .item-card-header {
            background: linear-gradient(135deg, #8b1a1a 0%, #a02020 100%); color: #fff; padding: 20px 24px;
        }
        .item-card-header h2 { font-size: 1.125rem; margin-bottom: 4px; }
        .item-card-header .subtitle { color: #94a3b8; font-size: 0.875rem; }

        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 999px;
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .status-checked_in { background: #dcfce7; color: #166534; }
        .status-checked_out { background: #fef3c7; color: #92400e; }
        .status-tested { background: #dbeafe; color: #1e40af; }
        .status-will_be_reused { background: #e0e7ff; color: #3730a3; }
        .status-recycling { background: #fce7f3; color: #9d174d; }

        .overdue-alert {
            background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;
            padding: 10px 16px; margin: 16px 20px 0; font-size: 0.85rem; color: #92400e;
        }

        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 1px; background: #e5e7eb;
        }
        .detail-cell { background: #fff; padding: 14px 20px; }
        .detail-cell label {
            display: block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.05em; color: #64748b; margin-bottom: 4px;
        }
        .detail-cell .value { font-size: 0.95rem; font-weight: 500; }
        .damage-yes { color: #dc2626; font-weight: 700; }
        .damage-no { color: #16a34a; }

        .description-section {
            padding: 16px 20px; border-top: 1px solid #e5e7eb;
        }
        .description-section label {
            display: block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.05em; color: #64748b; margin-bottom: 6px;
        }
        .description-section p { font-size: 0.95rem; line-height: 1.5; color: #374151; }

        /* Edit Details */
        .edit-section { padding: 20px; border-top: 1px solid #e5e7eb; }
        .edit-section h3 { font-size: 0.875rem; margin-bottom: 12px; color: #374151; }
        .edit-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;
        }
        .edit-group label {
            display: block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.05em; color: #64748b; margin-bottom: 4px;
        }
        .edit-input {
            width: 100%; padding: 8px 12px; border: 1px solid #d1d5db;
            border-radius: 8px; font-size: 0.875rem; font-family: inherit;
        }
        .edit-input:focus { outline: none; border-color: #8b1a1a; box-shadow: 0 0 0 2px rgba(139,26,26,0.15); }
        textarea.edit-input { resize: vertical; min-height: 50px; }
        .btn-save-edit {
            padding: 10px 24px; background: #8b1a1a; color: #fff; border: none;
            border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer;
        }
        .btn-save-edit:hover { opacity: 0.85; }
        .btn-save-edit:disabled { opacity: 0.4; cursor: not-allowed; }
        .edit-message {
            margin-top: 10px; padding: 8px 12px; border-radius: 8px;
            font-size: 0.85rem; display: none;
        }
        .edit-message.success { display: block; background: #dcfce7; color: #166534; }
        .edit-message.error { display: block; background: #fee2e2; color: #991b1b; }

        .actions { padding: 20px; border-top: 1px solid #e5e7eb; }
        .actions h3 { font-size: 0.875rem; margin-bottom: 8px; color: #374151; }
        .action-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .action-input {
            flex: 1; min-width: 150px; padding: 8px 12px; border: 1px solid #d1d5db;
            border-radius: 8px; font-size: 0.875rem; font-family: inherit;
        }
        .action-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }
        .notes-input {
            width: 100%; padding: 8px 12px; border: 1px solid #d1d5db;
            border-radius: 8px; font-size: 0.875rem; margin-bottom: 12px;
            font-family: inherit; resize: vertical; min-height: 36px;
        }
        .notes-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }
        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: opacity 0.15s;
        }
        .btn:hover { opacity: 0.85; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-checkout { background: #f59e0b; color: #fff; }
        .btn-checkin { background: #16a34a; color: #fff; }
        .btn-tested { background: #2563eb; color: #fff; }
        .btn-reuse { background: #6366f1; color: #fff; }
        .btn-recycle { background: #ec4899; color: #fff; }

        .status-message {
            margin-top: 12px; padding: 10px 14px; border-radius: 8px;
            font-size: 0.875rem; display: none;
        }
        .status-message.success { display: block; background: #dcfce7; color: #166534; }
        .status-message.error { display: block; background: #fee2e2; color: #991b1b; }

        .last-updated {
            padding: 12px 20px; border-top: 1px solid #e5e7eb;
            font-size: 0.75rem; color: #94a3b8; text-align: right;
        }

        /* Archive bar */
        .archive-bar {
            padding: 12px 20px; border-top: 1px solid #e5e7eb;
            display: flex; align-items: center; justify-content: space-between;
        }
        .btn-archive {
            padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer;
            background: #f8fafc; color: #64748b;
        }
        .btn-archive:hover { background: #e2e8f0; }
        .btn-archive.active { background: #f59e0b; color: #1a1a2e; border-color: #f59e0b; }

        /* Status Log */
        .log-section {
            background: #fff; border-radius: 12px; margin-top: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
        }
        .log-section-header {
            padding: 16px 20px; border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem; font-weight: 600; color: #374151;
        }
        .log-entry {
            padding: 14px 20px; border-bottom: 1px solid #f1f5f9;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry-top {
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
        }
        .log-arrow { color: #94a3b8; font-size: 0.8rem; }
        .log-date { color: #94a3b8; font-size: 0.75rem; margin-left: auto; }
        .log-changed-by { font-size: 0.75rem; color: #6366f1; font-weight: 500; }
        .log-notes {
            margin-top: 8px; font-size: 0.85rem; color: #475569;
            line-height: 1.4;
        }
        .log-notes-empty {
            margin-top: 6px; font-size: 0.8rem; color: #94a3b8; font-style: italic;
        }
        .log-notes-edit {
            margin-top: 8px; display: flex; gap: 8px; align-items: flex-start;
        }
        .log-notes-input {
            flex: 1; padding: 6px 10px; border: 1px solid #d1d5db;
            border-radius: 6px; font-size: 0.8rem; font-family: inherit;
            resize: vertical; min-height: 32px;
        }
        .log-notes-input:focus { outline: none; border-color: #2563eb; }
        .btn-save-note {
            padding: 6px 14px; background: #2563eb; color: #fff;
            border: none; border-radius: 6px; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .btn-save-note:hover { opacity: 0.85; }
        .btn-edit-note {
            padding: 4px 10px; background: #f1f5f9; color: #475569;
            border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.7rem;
            cursor: pointer; margin-left: 8px;
        }
        .btn-edit-note:hover { background: #e2e8f0; }
        .log-empty {
            padding: 30px 20px; text-align: center; color: #94a3b8; font-size: 0.875rem;
        }

        /* Field change log entries */
        .log-field-change {
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
        }
        .log-field-name {
            font-size: 0.75rem; font-weight: 600; color: #374151;
            text-transform: uppercase; letter-spacing: 0.03em;
            background: #f1f5f9; padding: 2px 8px; border-radius: 4px;
        }
        .log-old-value {
            font-size: 0.8rem; color: #94a3b8; text-decoration: line-through;
        }
        .log-new-value {
            font-size: 0.8rem; color: #166534; font-weight: 500;
        }
        .log-type-badge {
            font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em; padding: 2px 8px; border-radius: 4px;
        }
        .log-type-status { background: #dbeafe; color: #1e40af; }
        .log-type-field { background: #fef3c7; color: #92400e; }
        .log-type-created { background: #dcfce7; color: #166534; }

        /* QR Code section */
        .qr-section {
            padding: 20px; border-top: 1px solid #e5e7eb; text-align: center;
        }
        .qr-section h3 {
            font-size: 0.875rem; margin-bottom: 12px; color: #374151;
        }
        .qr-code-img {
            border: 2px solid #e5e7eb; border-radius: 8px; padding: 8px;
            background: #fff; cursor: pointer;
        }
        .qr-code-img:hover { border-color: #8b1a1a; }

        /* Photos section */
        .photos-section {
            padding: 20px; border-top: 1px solid #e5e7eb;
        }
        .photos-section h3 {
            font-size: 0.875rem; margin-bottom: 12px; color: #374151;
        }
        .photos-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px; margin-bottom: 16px;
        }
        .photo-card {
            position: relative; border-radius: 8px; overflow: hidden;
            border: 1px solid #e5e7eb; aspect-ratio: 1;
        }
        .photo-card img {
            width: 100%; height: 100%; object-fit: cover; cursor: pointer;
        }
        .photo-card .photo-delete {
            position: absolute; top: 4px; right: 4px; background: rgba(220,38,38,0.9);
            color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .photo-card .photo-caption {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.6); color: #fff; padding: 4px 8px;
            font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .photo-upload-inline {
            border: 2px dashed #d1d5db; border-radius: 8px; padding: 16px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
        }
        .photo-upload-inline:hover { border-color: #8b1a1a; }
        .photo-upload-inline p { color: #64748b; font-size: 0.8rem; }
        .photo-upload-inline .icon { font-size: 1.5rem; margin-bottom: 4px; }
        .upload-progress {
            margin-top: 8px; font-size: 0.8rem; color: #64748b; display: none;
        }

        .tag-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip {
            display: inline-block; padding: 6px 14px; border-radius: 999px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer;
            background: #f1f5f9; color: #475569; border: 2px solid #d1d5db;
            transition: all 0.15s; user-select: none;
        }
        .tag-chip:hover { border-color: #8b1a1a; }
        .tag-chip.active { background: #8b1a1a; color: #fff; border-color: #8b1a1a; }
        .tag-chip .remove-tag {
            margin-left: 6px; font-weight: 700; font-size: 0.9rem;
        }

        .location-custom-wrap { margin-top: 8px; display: none; }

        .nav-links { margin-top: 16px; text-align: center; }
        .nav-links a { color: #2563eb; text-decoration: none; font-size: 0.875rem; margin: 0 12px; }
        .nav-links a:hover { text-decoration: underline; }

        @media (max-width: 600px) {
            .detail-grid { grid-template-columns: 1fr; }
            .edit-row { grid-template-columns: 1fr; }
            .action-row { flex-direction: column; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { width: 100%; text-align: center; }
            .header { flex-direction: column; gap: 8px; text-align: center; }
            .photos-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
        }

        /* Print single label for Brother QL-820NWB (62mm x 62mm, 2.4" roll) */
        .print-single-label { display: none; }
        @media print {
            .header, .container { display: none !important; }
            .print-single-label {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                width: 58mm; height: 58mm;
                padding: 2mm; gap: 1mm;
            }
            .print-single-label .qr-box {
                width: 50mm; height: 50mm;
                flex-shrink: 0;
                display: flex; align-items: center; justify-content: center;
                overflow: hidden;
            }
            .print-single-label .qr-box img { width: 100% !important; height: 100% !important; object-fit: contain; }
            .print-single-label .lbl-text { text-align: center; font-family: Arial, sans-serif; line-height: 1.2; overflow: hidden; width: 100%; }
            .print-single-label .lbl-mfr { font-size: 8pt; font-weight: 700; }
            .print-single-label .lbl-detail { font-size: 7pt; color: #333; }
            @page { size: 62mm 62mm; margin: 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/dashboard/" class="header-brand" style="text-decoration:none;">
            <img src="{% static 'inventory/img/logo.png' %}" alt="Fire &amp; Risk Alliance">
            <div class="header-brand-text">
                <h1>Fire &amp; Risk Alliance</h1>
                <div class="subtitle">Inventory Management System</div>
            </div>
        </a>
        <a href="/dashboard/">View Full Inventory</a>
    </div>

    <div class="container">
        {% if error %}
        <div class="error-card">
            <h2>Item Not Found</h2>
            <p>{{ error }}</p>
        </div>
        <div class="nav-links">
            <a href="/dashboard/">Browse All Inventory</a>
        </div>

        {% elif item %}
        <div class="item-card">
            <div class="item-card-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2>{{ item.manufacturer }} - Box {{ item.box_id }}</h2>
                        <div class="subtitle">Pallet: {{ item.pallet_id }}</div>
                    </div>
                    <span class="status-badge status-{{ item.status }}" id="statusBadge">
                        {{ item.get_status_display }}
                    </span>
                </div>
            </div>

            {% if item.is_overdue %}
            <div class="overdue-alert">
                <strong>Overdue!</strong> This item has been checked out for {{ item.days_checked_out }} days
                {% if item.checked_out_by %} by {{ item.checked_out_by }}{% endif %}.
            </div>
            {% endif %}

            <div class="detail-grid">
                <div class="detail-cell">
                    <label>Manufacturer / Supplier</label>
                    <div class="value">{{ item.manufacturer }}</div>
                </div>
                <div class="detail-cell">
                    <label>Pallet ID</label>
                    <div class="value">{{ item.pallet_id }}</div>
                </div>
                <div class="detail-cell">
                    <label>Box ID</label>
                    <div class="value">#{{ item.box_id }}</div>
                </div>
                <div class="detail-cell">
                    <label>Tag ID</label>
                    <div class="value" style="font-weight:700; color:#8b1a1a;">{{ item.tag_id }}</div>
                </div>
                <div class="detail-cell">
                    <label>Contents (qty)</label>
                    <div class="value">{{ item.content }}</div>
                </div>
                <div class="detail-cell">
                    <label>Project Number</label>
                    <div class="value">{{ item.project_number|default:"-" }}</div>
                </div>
                <div class="detail-cell">
                    <label>Receiving Location</label>
                    <div class="value">{{ item.location }}</div>
                </div>
                <div class="detail-cell">
                    <label>Damage Reported</label>
                    <div class="value {% if item.damaged %}damage-yes{% else %}damage-no{% endif %}">
                        {{ item.get_damaged_display }}
                    </div>
                </div>
                {% if item.checked_out_by %}
                <div class="detail-cell">
                    <label>Checked Out By</label>
                    <div class="value">{{ item.checked_out_by }}</div>
                </div>
                <div class="detail-cell">
                    <label>Checked Out Since</label>
                    <div class="value">{{ item.checked_out_at|date:"M d, Y H:i" }}</div>
                </div>
                {% endif %}
            </div>

            {% if item.description %}
            <div class="description-section">
                <label>Brief Description of Shipment</label>
                <p>{{ item.description }}</p>
            </div>
            {% endif %}

            {% if item.tags %}
            <div class="description-section">
                <label>Tags</label>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
                    {% for tag in item.tags_list %}
                    <span style="display:inline-block; padding:4px 12px; border-radius:999px; font-size:0.75rem; font-weight:600; background:#e0e7ff; color:#3730a3;">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="qr-section">
                <h3>QR Code</h3>
                <img class="qr-code-img" src="{{ item.short_qr_url }}" alt="QR Code for {{ item.manufacturer }} Box #{{ item.box_id }}"
                     onclick="printSingleLabel()" title="Click to print label">
                <div style="margin-top:8px; font-size:0.85rem; font-weight:600; color:#374151; line-height:1.5;">
                    {{ item.manufacturer }}<br>
                    Pallet {{ item.pallet_id }} &bull; Box #{{ item.box_id }}
                </div>
                <button onclick="printSingleLabel()" style="display:inline-block; margin-top:10px; padding:10px 20px; background:#7c3aed; color:#fff; border:none; border-radius:8px; font-size:0.9rem; font-weight:600; cursor:pointer;">
                    Print QR Label
                </button>
            </div>

            <!-- Photos -->
            <div class="photos-section">
                <h3>Photos</h3>
                <div class="photos-grid" id="photosGrid">
                    {% for photo in photos %}
                    <div class="photo-card" id="photo-{{ photo.id }}">
                        <img src="{{ photo.image.url }}" alt="{{ photo.caption }}"
                             onclick="window.open('{{ photo.image.url }}', '_blank')">
                        <button class="photo-delete" onclick="deletePhoto({{ photo.id }})" title="Delete photo">&times;</button>
                        {% if photo.caption %}<div class="photo-caption">{{ photo.caption }}</div>{% endif %}
                    </div>
                    {% empty %}
                    <p style="color:#94a3b8; font-size:0.85rem; grid-column:1/-1;">No photos yet.</p>
                    {% endfor %}
                </div>
                <div class="photo-upload-inline" onclick="document.getElementById('itemPhotoInput').click();">
                    <div class="icon">&#128247;</div>
                    <p>Click to upload a photo</p>
                </div>
                <input type="file" id="itemPhotoInput" accept="image/*" style="display:none;" onchange="uploadItemPhoto({{ item.id }})">
                <div class="upload-progress" id="uploadProgress">Uploading...</div>
            </div>

            <div class="edit-section">
                <h3>Edit Details &amp; Update Status</h3>
                <div class="edit-row">
                    <div class="edit-group">
                        <label>Contents (Qty)</label>
                        <input type="number" class="edit-input" id="editContent" value="{{ item.content }}" min="0">
                    </div>
                    <div class="edit-group">
                        <label>Damage Reported</label>
                        <select class="edit-input" id="editDamaged">
                            <option value="false" {% if not item.damaged %}selected{% endif %}>No</option>
                            <option value="true" {% if item.damaged %}selected{% endif %}>Yes</option>
                        </select>
                    </div>
                </div>
                <div class="edit-row">
                    <div class="edit-group">
                        <label>Receiving Location</label>
                        <select class="edit-input" id="editLocationSelect" onchange="toggleEditCustomLocation()">
                            {% for loc in location_choices %}
                            <option value="{{ loc }}" {% if item.location == loc %}selected{% endif %}>{{ loc }}</option>
                            {% endfor %}
                            <option value="other" {% if item.location not in location_choices %}selected{% endif %}>Other</option>
                        </select>
                        <div class="location-custom-wrap" id="editCustomLocationWrap">
                            <input type="text" class="edit-input" id="editLocationCustom"
                                value="{% if item.location not in location_choices %}{{ item.location }}{% endif %}"
                                placeholder="Enter custom location">
                        </div>
                        <input type="hidden" id="editLocation" value="{{ item.location }}">
                    </div>
                    <div class="edit-group">
                        <label>Description</label>
                        <input type="text" class="edit-input" id="editDescription" value="{{ item.description }}">
                    </div>
                </div>
                <div class="edit-row">
                    <div class="edit-group">
                        <label>Project Number</label>
                        <input type="text" class="edit-input" id="editProjectNumber" value="{{ item.project_number }}">
                    </div>
                    <div class="edit-group">
                        <label>Manufacturer / Supplier</label>
                        <input type="text" class="edit-input" id="editManufacturer" value="{{ item.manufacturer }}">
                    </div>
                </div>

                <!-- Tags -->
                <div class="edit-group" style="margin-top:12px;">
                    <label>Tags / Keywords</label>
                    <div class="tag-chips" id="tagChips">
                        {% for tag in preset_tags %}
                        <span class="tag-chip" data-tag="{{ tag }}" onclick="toggleTag(this)">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <input type="text" class="edit-input" id="customTagInput" placeholder="Add custom tag..." style="flex:1;">
                        <button type="button" onclick="addCustomTag()" style="padding:6px 14px; background:#8b1a1a; color:#fff; border:none; border-radius:6px; font-size:0.8rem; cursor:pointer;">Add</button>
                    </div>
                    <input type="hidden" id="tagsHidden" value="{{ item.tags }}">
                </div>

                <!-- Status Update (integrated into Edit Details) -->
                <div style="border-top:1px solid #e5e7eb; margin-top:16px; padding-top:16px;">
                    <label style="display:block; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:#64748b; margin-bottom:6px;">Status</label>
                    <select class="edit-input" id="editStatus" style="margin-bottom:12px;">
                        <option value="checked_in" {% if item.status == 'checked_in' %}selected{% endif %}>Checked In</option>
                        <option value="checked_out" {% if item.status == 'checked_out' %}selected{% endif %}>Checked Out</option>
                        <option value="tested" {% if item.status == 'tested' %}selected{% endif %}>Tested</option>
                        <option value="will_be_reused" {% if item.status == 'will_be_reused' %}selected{% endif %}>Will Be Reused</option>
                        <option value="recycling" {% if item.status == 'recycling' %}selected{% endif %}>Recycling</option>
                    </select>
                    <div class="edit-row">
                        <div class="edit-group">
                            <label>Your Name <span style="text-transform:none; letter-spacing:normal; font-weight:400;">(optional, for audit trail)</span></label>
                            <input type="text" class="edit-input" id="changedByInput" placeholder="Your name">
                        </div>
                        <div class="edit-group">
                            <label>Notes <span style="text-transform:none; letter-spacing:normal; font-weight:400;">(optional)</span></label>
                            <input type="text" class="edit-input" id="statusNotes" placeholder="Add notes...">
                        </div>
                    </div>
                </div>

                <button class="btn-save-edit" id="btnSaveEdit" onclick="saveEdit({{ item.id }})" style="margin-top:12px;">Save Changes</button>
                <div class="edit-message" id="editMessage"></div>
            </div>

            <!-- Archive -->
            <div class="archive-bar">
                <span style="font-size:0.8rem; color:#64748b;">
                    {% if item.archived %}This item is archived.{% else %}Move to archive when no longer needed.{% endif %}
                </span>
                <button class="btn-archive {% if item.archived %}active{% endif %}" id="archiveBtn"
                    onclick="toggleArchive({{ item.id }}, {{ item.archived|yesno:'false,true' }})">
                    {% if item.archived %}Unarchive{% else %}Archive Item{% endif %}
                </button>
            </div>

            <div class="last-updated" id="lastUpdated">
                Last updated: {{ item.updated_at|date:"M d, Y H:i" }}
            </div>
        </div>

        <!-- Audit Trail -->
        <div class="log-section">
            <div class="log-section-header">Audit Trail</div>
            <div id="historyLog">
                {% for entry in audit_trail %}
                <div class="log-entry">
                    {% if entry.entry_type == 'status' %}
                    {# Status change entry #}
                    <div class="log-entry-top">
                        <span class="log-type-badge log-type-status">Status</span>
                        {% if entry.old_status %}
                        <span class="status-badge status-{{ entry.old_status }}">{{ entry.old_status_label }}</span>
                        <span class="log-arrow">&rarr;</span>
                        {% endif %}
                        <span class="status-badge status-{{ entry.new_status }}">{{ entry.new_status_label }}</span>
                        {% if entry.changed_by %}<span class="log-changed-by">by {{ entry.changed_by }}</span>{% endif %}
                        <span class="log-date">{{ entry.changed_at|date:"M d, Y H:i:s" }}</span>
                    </div>
                    {% if entry.notes %}
                    <div class="log-notes">{{ entry.notes }}</div>
                    {% endif %}

                    {% elif entry.entry_type == 'change' %}
                    {# Field change or creation entry #}
                    <div class="log-entry-top">
                        {% if entry.change_type == 'created' %}
                        <span class="log-type-badge log-type-created">Created</span>
                        <span style="font-size:0.85rem; color:#374151;">Item checked in</span>
                        {% else %}
                        <span class="log-type-badge log-type-field">Edit</span>
                        <div class="log-field-change">
                            <span class="log-field-name">{{ entry.field_label }}</span>
                            {% if entry.old_value %}
                            <span class="log-old-value">{{ entry.old_value }}</span>
                            <span class="log-arrow">&rarr;</span>
                            {% endif %}
                            <span class="log-new-value">{{ entry.new_value }}</span>
                        </div>
                        {% endif %}
                        {% if entry.changed_by %}<span class="log-changed-by">by {{ entry.changed_by }}</span>{% endif %}
                        <span class="log-date">{{ entry.changed_at|date:"M d, Y H:i:s" }}</span>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="log-empty">No changes recorded yet.</div>
                {% endfor %}
            </div>
        </div>

        <div class="nav-links">
            <a href="/dashboard/">View Full Inventory</a>
        </div>
        {% endif %}
    </div>

    {% if item %}
    <script>
        const STATUS_MAP = {
            'Checked In': 'checked_in',
            'Checked Out': 'checked_out',
            'Tested': 'tested',
            'Will Be Reused': 'will_be_reused',
            'Recycling': 'recycling'
        };

        function addLogEntry(data, notes, changedBy) {
            const log = document.getElementById('historyLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const newKey = STATUS_MAP[data.status] || 'checked_in';

            const now = new Date().toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            const notesHtml = notes
                ? `<div class="log-notes">${escapeHtml(notes)}</div>`
                : `<div class="log-notes-empty">No notes</div>`;

            const byHtml = changedBy
                ? `<span class="log-changed-by">by ${escapeHtml(changedBy)}</span>`
                : '';

            entry.innerHTML = `
                <div class="log-entry-top">
                    <span class="status-badge status-${newKey}">${escapeHtml(data.status)}</span>
                    ${byHtml}
                    <span class="log-date">${now} (just now)</span>
                </div>
                ${notesHtml}
            `;
            log.insertBefore(entry, log.firstChild);
        }

        function showEditNotes(historyId) {
            document.getElementById('notes-display-' + historyId).style.display = 'none';
            document.getElementById('notes-edit-' + historyId).style.display = 'flex';
            document.getElementById('notes-input-' + historyId).focus();
        }

        async function saveNotes(historyId) {
            const input = document.getElementById('notes-input-' + historyId);
            const notes = input.value;

            try {
                const formData = new FormData();
                formData.append('history_id', historyId);
                formData.append('notes', notes);

                const resp = await fetch('/api/update-notes/', {
                    method: 'POST',
                    body: formData
                });

                const data = await resp.json();

                if (data.success) {
                    const display = document.getElementById('notes-display-' + historyId);
                    if (notes) {
                        display.innerHTML = `<div class="log-notes">${escapeHtml(notes)} <button class="btn-edit-note" onclick="showEditNotes(${historyId})">Edit</button></div>`;
                    } else {
                        display.innerHTML = `<div class="log-notes-empty">No notes <button class="btn-edit-note" onclick="showEditNotes(${historyId})">Add</button></div>`;
                    }
                    display.style.display = 'block';
                    document.getElementById('notes-edit-' + historyId).style.display = 'none';
                }
            } catch (err) {
                alert('Failed to save notes. Please try again.');
            }
        }

        // ---- Location dropdown ----
        function toggleEditCustomLocation() {
            const sel = document.getElementById('editLocationSelect');
            const wrap = document.getElementById('editCustomLocationWrap');
            const hidden = document.getElementById('editLocation');
            if (sel.value === 'other') {
                wrap.style.display = 'block';
                hidden.value = document.getElementById('editLocationCustom').value;
            } else {
                wrap.style.display = 'none';
                hidden.value = sel.value;
            }
        }
        // Update hidden field when custom input changes
        document.addEventListener('DOMContentLoaded', function() {
            toggleEditCustomLocation();
            const customInput = document.getElementById('editLocationCustom');
            if (customInput) {
                customInput.addEventListener('input', function() {
                    document.getElementById('editLocation').value = this.value;
                });
            }
        });

        // ---- Photo upload ----
        async function uploadItemPhoto(itemId) {
            const input = document.getElementById('itemPhotoInput');
            const progress = document.getElementById('uploadProgress');
            if (!input.files.length) return;

            progress.style.display = 'block';
            progress.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('item_id', itemId);
            formData.append('photo', input.files[0]);
            formData.append('caption', '');

            try {
                const resp = await fetch('/api/upload-photo/', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.success) {
                    // Add photo to grid
                    const grid = document.getElementById('photosGrid');
                    const emptyMsg = grid.querySelector('p');
                    if (emptyMsg) emptyMsg.remove();

                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    card.id = 'photo-' + data.photo_id;
                    card.innerHTML = `
                        <img src="${data.photo_url}" alt="Photo" onclick="window.open('${data.photo_url}', '_blank')">
                        <button class="photo-delete" onclick="deletePhoto(${data.photo_id})" title="Delete photo">&times;</button>
                    `;
                    grid.appendChild(card);
                    progress.textContent = 'Photo uploaded!';
                    setTimeout(() => { progress.style.display = 'none'; }, 2000);
                } else {
                    progress.textContent = 'Error: ' + (data.error || 'Upload failed');
                }
            } catch (err) {
                progress.textContent = 'Network error. Please try again.';
            }
            input.value = '';
        }

        async function deletePhoto(photoId) {
            if (!confirm('Delete this photo?')) return;
            try {
                const resp = await fetch('/api/delete-photo/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({photo_id: photoId})
                });
                const data = await resp.json();
                if (data.success) {
                    const card = document.getElementById('photo-' + photoId);
                    if (card) card.remove();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Network error.');
            }
        }

        // ---- Tag management ----
        function getSelectedTags() {
            return Array.from(document.querySelectorAll('.tag-chip.active')).map(c => c.dataset.tag);
        }
        function updateTagsHidden() {
            document.getElementById('tagsHidden').value = getSelectedTags().join(',');
        }
        function toggleTag(chip) {
            chip.classList.toggle('active');
            updateTagsHidden();
        }
        function addCustomTag() {
            const input = document.getElementById('customTagInput');
            const val = input.value.trim();
            if (!val) return;
            const existing = document.querySelector(`.tag-chip[data-tag="${val}"]`);
            if (existing) { existing.classList.add('active'); updateTagsHidden(); input.value = ''; return; }
            const chip = document.createElement('span');
            chip.className = 'tag-chip active';
            chip.dataset.tag = val;
            chip.innerHTML = val + '<span class="remove-tag" onclick="event.stopPropagation(); this.parentElement.remove(); updateTagsHidden();">&times;</span>';
            chip.onclick = function() { toggleTag(this); };
            document.getElementById('tagChips').appendChild(chip);
            updateTagsHidden();
            input.value = '';
        }
        document.getElementById('customTagInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); addCustomTag(); }
        });

        // Initialize tags from item's current tags
        (function() {
            const savedTags = document.getElementById('tagsHidden').value;
            if (savedTags) {
                const presetNames = Array.from(document.querySelectorAll('.tag-chip')).map(c => c.dataset.tag);
                savedTags.split(',').forEach(t => {
                    t = t.trim();
                    if (!t) return;
                    const chip = document.querySelector(`.tag-chip[data-tag="${t}"]`);
                    if (chip) { chip.classList.add('active'); }
                    else {
                        // Custom tag - add it
                        const c = document.createElement('span');
                        c.className = 'tag-chip active';
                        c.dataset.tag = t;
                        c.innerHTML = t + '<span class="remove-tag" onclick="event.stopPropagation(); this.parentElement.remove(); updateTagsHidden();">&times;</span>';
                        c.onclick = function() { toggleTag(this); };
                        document.getElementById('tagChips').appendChild(c);
                    }
                });
            }
        })();

        // ---- Edit Details (with integrated status update) ----
        async function saveEdit(itemId) {
            const btn = document.getElementById('btnSaveEdit');
            const msgEl = document.getElementById('editMessage');
            btn.disabled = true;
            msgEl.className = 'edit-message';
            msgEl.style.display = 'none';

            // Update location from dropdown
            const locSel = document.getElementById('editLocationSelect');
            if (locSel) {
                if (locSel.value === 'other') {
                    document.getElementById('editLocation').value = document.getElementById('editLocationCustom').value;
                } else {
                    document.getElementById('editLocation').value = locSel.value;
                }
            }

            // Update tags hidden input
            updateTagsHidden();

            const payload = {
                item_id: itemId,
                content: parseInt(document.getElementById('editContent').value),
                damaged: document.getElementById('editDamaged').value === 'true',
                location: document.getElementById('editLocation').value,
                description: document.getElementById('editDescription').value,
                project_number: document.getElementById('editProjectNumber').value,
                manufacturer: document.getElementById('editManufacturer').value,
                tags: document.getElementById('tagsHidden').value,
                status: document.getElementById('editStatus').value,
                changed_by: document.getElementById('changedByInput').value,
                notes: document.getElementById('statusNotes').value,
            };

            try {
                const resp = await fetch('/api/edit-item/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    // Reload the page to show the saved data from the database
                    location.reload();
                    return;
                } else {
                    msgEl.textContent = 'Error: ' + (data.error || 'Unknown');
                    msgEl.className = 'edit-message error';
                }
            } catch (err) {
                msgEl.textContent = 'Network error. Please try again.';
                msgEl.className = 'edit-message error';
            }
            btn.disabled = false;
        }

        // ---- Archive ----
        async function toggleArchive(itemId, archive) {
            try {
                const resp = await fetch('/api/archive-item/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({item_id: itemId, archive: archive})
                });
                const data = await resp.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Network error.');
            }
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    </script>
    {% endif %}

    {% if item %}
    <!-- Hidden print-only label for Brother QL-820NWB (29mm x 90mm) -->
    <div class="print-single-label" id="printLabel">
        <div class="qr-box">
            <img src="{{ item.short_qr_url }}" alt="QR">
        </div>
        <div class="lbl-text">
            <div class="lbl-mfr">{{ item.manufacturer }}</div>
            <div class="lbl-detail">Box #{{ item.box_id }}</div>
            <div class="lbl-detail">Pallet {{ item.pallet_id }}</div>
            <div class="lbl-detail">{{ item.project_number|default:"" }}</div>
        </div>
    </div>
    <script>
    function printSingleLabel() {
        window.print();
    }
    </script>
    {% endif %}
</body>
</html>
