{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRATrack - Add Shipment</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff; --bg-secondary: #f5f5f7; --text-primary: #1d1d1f; --text-secondary: #6e6e73;
            --text-tertiary: #86868b; --accent: #8b1a1a; --accent-hover: #a02020; --border: #d2d2d7;
            --border-light: #e8e8ed; --input-bg: #ffffff; --card-bg: #ffffff;
            --nav-bg: rgba(255,255,255,0.72); --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --green: #34c759; --green-bg: #f0fdf4; --green-text: #166534;
            --red: #ff3b30; --red-bg: #fef2f2; --red-text: #991b1b;
        }
        body.dark-mode {
            --bg: #000000; --bg-secondary: #1c1c1e; --text-primary: #f5f5f7; --text-secondary: #a1a1a6;
            --text-tertiary: #6e6e73; --accent: #ff6b6b; --accent-hover: #ff8585; --border: #38383a;
            --border-light: #2c2c2e; --input-bg: #1c1c1e; --card-bg: #1c1c1e;
            --nav-bg: rgba(0,0,0,0.72); --shadow: 0 2px 12px rgba(0,0,0,0.3);
            --green: #30d158; --green-bg: #0a2613; --green-text: #4ade80;
            --red: #ff453a; --red-bg: #2c1515; --red-text: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            padding-top: 64px;
        }

        /* ---- Frosted glass nav ---- */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: var(--nav-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid var(--border);
            height: 48px;
        }
        .nav-inner {
            max-width: 980px; margin: 0 auto; height: 100%;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
        }
        .nav-brand {
            display: flex; align-items: center; gap: 10px;
            text-decoration: none; color: var(--text-primary);
        }
        .nav-logo {
            width: 28px; height: 28px; border-radius: 6px;
            background: linear-gradient(135deg, #8b1a1a, #c0392b);
            color: #fff; font-size: 11px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            letter-spacing: -0.5px;
        }
        body.dark-mode .nav-logo {
            background: linear-gradient(135deg, #ff6b6b, #c0392b);
        }
        .nav-title {
            font-size: 15px; font-weight: 600; color: var(--text-primary);
        }
        .nav-right {
            display: flex; align-items: center; gap: 16px;
        }
        .nav-back {
            font-size: 13px; font-weight: 500; color: var(--accent);
            text-decoration: none; transition: opacity 0.2s;
        }
        .nav-back:hover { opacity: 0.7; }
        .dark-toggle-btn {
            background: none; border: none; cursor: pointer;
            color: var(--text-secondary); padding: 4px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; transition: background 0.2s;
        }
        .dark-toggle-btn:hover { background: var(--bg-secondary); }

        /* ---- Container ---- */
        .container { max-width: 700px; margin: 24px auto; padding: 0 16px; }

        /* ---- Form card ---- */
        .form-card {
            background: var(--card-bg);
            border: 0.5px solid var(--border-light);
            border-radius: 14px;
            overflow: hidden;
        }
        .form-card-header {
            padding: 24px 24px 0 24px;
        }
        .form-card-header h2 {
            font-size: 1.25rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 4px;
        }
        .form-card-header p {
            color: var(--text-secondary); font-size: 0.85rem; font-weight: 400;
        }

        .form-body { padding: 24px; }

        /* ---- Form elements ---- */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; font-size: 0.8rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-primary); margin-bottom: 6px;
        }
        .form-group .hint {
            font-size: 0.75rem; color: var(--text-tertiary); font-weight: 400;
            text-transform: none; letter-spacing: normal;
        }
        .form-input {
            width: 100%; padding: 10px 14px;
            border: 0.5px solid var(--border);
            border-radius: 10px; font-size: 0.9rem; font-family: inherit;
            background: var(--input-bg); color: var(--text-primary);
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(139,26,26,0.1);
        }
        body.dark-mode .form-input:focus {
            box-shadow: 0 0 0 3px rgba(255,107,107,0.15);
        }
        textarea.form-input { resize: vertical; min-height: 60px; }
        select.form-input { cursor: pointer; }

        .form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
        }

        .form-section {
            border-top: 0.5px solid var(--border-light);
            padding-top: 20px; margin-top: 20px;
        }
        .form-section h3 {
            font-size: 0.9rem; font-weight: 600; color: var(--text-primary);
            margin-bottom: 12px;
        }

        /* ---- Pallet display ---- */
        .pallet-display {
            background: var(--green-bg);
            border: 0.5px solid var(--green);
            border-radius: 10px;
            padding: 12px 14px; font-size: 1.1rem; font-weight: 700;
            color: var(--green-text);
            text-align: center;
        }

        /* ---- Submit button ---- */
        .btn-submit {
            width: 100%; padding: 14px;
            background: var(--accent); color: #ffffff;
            border: none; border-radius: 10px;
            font-size: 1rem; font-weight: 600; font-family: inherit;
            cursor: pointer; margin-top: 8px;
            transition: background 0.2s;
        }
        .btn-submit:hover { background: var(--accent-hover); }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ---- Error list ---- */
        .error-list {
            background: var(--red-bg);
            border: 0.5px solid var(--red);
            border-radius: 10px;
            padding: 12px 16px; margin-bottom: 20px;
            color: var(--red-text); font-size: 0.85rem;
        }
        .error-list strong { font-weight: 600; }
        .error-list ul { margin: 6px 0 0 16px; }

        /* ---- Photo upload ---- */
        .photo-upload-area {
            border: 1px dashed var(--border);
            border-radius: 14px; padding: 24px;
            text-align: center; cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .photo-upload-area:hover { border-color: var(--accent); }
        .photo-upload-area.dragover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }
        .photo-upload-area p { color: var(--text-secondary); font-size: 0.85rem; }
        .photo-upload-area .icon { font-size: 2rem; margin-bottom: 8px; }
        .photo-preview-list {
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px;
        }
        .photo-preview-item {
            position: relative; width: 80px; height: 80px; border-radius: 10px;
            overflow: hidden; border: 0.5px solid var(--border);
        }
        .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview-item .remove-photo {
            position: absolute; top: 2px; right: 2px; background: var(--red);
            color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px;
            font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* ---- Location custom ---- */
        .location-custom-wrap { margin-top: 8px; display: none; }

        /* ---- Tag chips ---- */
        .tag-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip {
            display: inline-block; padding: 6px 14px; border-radius: 999px;
            font-size: 0.8rem; font-weight: 500; cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 0.5px solid var(--border);
            transition: all 0.15s; user-select: none;
        }
        .tag-chip:hover { border-color: var(--accent); color: var(--accent); }
        .tag-chip.active {
            background: var(--accent); color: #ffffff;
            border-color: var(--accent);
        }
        .tag-chip .remove-tag {
            margin-left: 6px; font-weight: 700; font-size: 0.9rem; cursor: pointer;
        }

        .custom-tag-add {
            padding: 8px 16px; background: var(--accent); color: #fff;
            border: none; border-radius: 10px; font-size: 0.85rem;
            font-family: inherit; font-weight: 500; cursor: pointer;
            transition: background 0.2s;
        }
        .custom-tag-add:hover { background: var(--accent-hover); }

        /* ---- Nav links ---- */
        .nav-links { margin-top: 16px; text-align: center; padding-bottom: 32px; }
        .nav-links a {
            color: var(--accent); text-decoration: none; font-size: 0.875rem; font-weight: 500;
        }
        .nav-links a:hover { text-decoration: underline; }

        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .nav-inner { padding: 0 16px; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-inner">
            <a href="/dashboard/" class="nav-brand">
                <div class="nav-logo">FR</div>
                <span class="nav-title">FRATrack</span>
            </a>
            <div class="nav-right">
                <a href="/dashboard/" class="nav-back">Dashboard</a>
                <button class="dark-toggle-btn" onclick="toggleDarkMode()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-card">
            <div class="form-card-header">
                <h2>Add New Shipment</h2>
                <p>Enter shipment details to create inventory items and generate QR codes</p>
            </div>
            <div class="form-body">
                {% if errors %}
                <div class="error-list">
                    <strong>Please fix the following:</strong>
                    <ul>
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <form method="POST" id="shipmentForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group">
                            <label>Manufacturer / Supplier</label>
                            <input type="text" name="manufacturer" class="form-input" required
                                value="{{ form_data.manufacturer|default:'' }}" placeholder="e.g. Panasonic">
                        </div>
                        <div class="form-group">
                            <label>Pallet ID <span class="hint">(auto-assigned)</span></label>
                            <div class="pallet-display" id="palletDisplay">{{ next_pallet_id }}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Project Number</label>
                        <input type="text" name="project_number" class="form-input"
                            value="{{ form_data.project_number|default:'' }}" placeholder="e.g. PRJ-2026-001">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Number of Boxes</label>
                            <input type="number" name="num_boxes" class="form-input" required min="1"
                                value="{{ form_data.num_boxes|default:'' }}" placeholder="e.g. 67">
                        </div>
                        <div class="form-group">
                            <label>Items Per Box <span class="hint">(default qty per box)</span></label>
                            <input type="number" name="items_per_box" class="form-input" required min="1"
                                value="{{ form_data.items_per_box|default:'' }}" placeholder="e.g. 50">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Receiving Location</label>
                            <select name="location" class="form-input" id="locationSelect" onchange="toggleCustomLocation()">
                                <option value="">-- Select Location --</option>
                                {% for loc in location_choices %}
                                <option value="{{ loc }}" {% if form_data.location == loc %}selected{% endif %}>{{ loc }}</option>
                                {% endfor %}
                                <option value="other" {% if form_data.location and form_data.location not in location_choices %}selected{% endif %}>Other (enter below)</option>
                            </select>
                            <div class="location-custom-wrap" id="customLocationWrap">
                                <input type="text" name="location_custom" class="form-input" id="customLocationInput"
                                    placeholder="Enter custom location"
                                    value="{% if form_data.location and form_data.location not in location_choices %}{{ form_data.location }}{% endif %}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Damage Reported?</label>
                            <select name="damaged" class="form-input">
                                <option value="no" {% if form_data.damaged == 'no' %}selected{% endif %}>No</option>
                                <option value="yes" {% if form_data.damaged == 'yes' %}selected{% endif %}>Yes</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Brief Description of Shipment</label>
                        <textarea name="description" class="form-input" placeholder="e.g. Lithium-ion batteries for testing">{{ form_data.description|default:'' }}</textarea>
                    </div>

                    <div class="form-section">
                        <h3>Photos (optional)</h3>
                        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click();">
                            <div class="icon">&#128247;</div>
                            <p>Click to upload photos or drag and drop</p>
                            <p class="hint">Upload photos of the shipment, labels, or damage</p>
                        </div>
                        <input type="file" id="photoInput" name="photos" multiple accept="image/*" style="display:none;" onchange="previewPhotos(this)">
                        <div class="photo-preview-list" id="photoPreviewList"></div>
                    </div>

                    <div class="form-section">
                        <h3>Tags / Keywords</h3>
                        <div class="form-group">
                            <label>Select Tags <span class="hint">(click to toggle)</span></label>
                            <div class="tag-chips" id="tagChips">
                                <span class="tag-chip" data-tag="Standard" onclick="toggleTag(this)">Standard</span>
                                <span class="tag-chip" data-tag="Initiating" onclick="toggleTag(this)">Initiating</span>
                                <span class="tag-chip" data-tag="Target" onclick="toggleTag(this)">Target</span>
                                <span class="tag-chip" data-tag="RP12" onclick="toggleTag(this)">RP12</span>
                                <span class="tag-chip" data-tag="RP48" onclick="toggleTag(this)">RP48</span>
                                <span class="tag-chip" data-tag="RP48-25kW" onclick="toggleTag(this)">RP48-25kW</span>
                                <span class="tag-chip" data-tag="RP48-40kW" onclick="toggleTag(this)">RP48-40kW</span>
                                <span class="tag-chip" data-tag="RP240" onclick="toggleTag(this)">RP240</span>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <input type="text" class="form-input" id="customTagInput" placeholder="Add custom tag..." style="flex:1;">
                                <button type="button" onclick="addCustomTag()" class="custom-tag-add">Add</button>
                            </div>
                            <input type="hidden" name="tags" id="tagsHidden" value="{{ form_data.tags|default:'' }}">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Exceptions (optional)</h3>
                        <div class="form-group">
                            <label>Damaged Box Numbers <span class="hint">(comma-separated, e.g. 3, 7, 12)</span></label>
                            <input type="text" name="damaged_boxes" class="form-input"
                                value="{{ form_data.damaged_boxes|default:'' }}" placeholder="Leave blank if none">
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">Create Items &amp; Generate QR Codes</button>
                </form>
            </div>
        </div>

        <div class="nav-links">
            <a href="/dashboard/">Back to Dashboard</a>
        </div>
    </div>

    <script>
        // Dark mode
        function toggleDarkMode() {
            var isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
        }
        if (localStorage.getItem('darkMode') === '1') {
            document.body.classList.add('dark-mode');
        }

        function toggleCustomLocation() {
            const select = document.getElementById('locationSelect');
            const wrap = document.getElementById('customLocationWrap');
            const input = document.getElementById('customLocationInput');
            if (select.value === 'other') {
                wrap.style.display = 'block';
                input.required = true;
            } else {
                wrap.style.display = 'none';
                input.required = false;
            }
        }
        // Initialize on page load
        toggleCustomLocation();

        // Photo preview
        function previewPhotos(input) {
            const list = document.getElementById('photoPreviewList');
            list.innerHTML = '';
            Array.from(input.files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item';
                    div.innerHTML = `<img src="${e.target.result}" alt="Photo ${idx + 1}">`;
                    list.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Drag and drop
        const uploadArea = document.getElementById('photoUploadArea');
        const photoInput = document.getElementById('photoInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            photoInput.files = e.dataTransfer.files;
            previewPhotos(photoInput);
        });

        // ---- Tag management ----
        function getSelectedTags() {
            return Array.from(document.querySelectorAll('.tag-chip.active')).map(c => c.dataset.tag);
        }
        function updateTagsHidden() {
            document.getElementById('tagsHidden').value = getSelectedTags().join(',');
        }
        function toggleTag(chip) {
            chip.classList.toggle('active');
            updateTagsHidden();
        }
        function addCustomTag() {
            const input = document.getElementById('customTagInput');
            const val = input.value.trim();
            if (!val) return;
            // Check if already exists
            const existing = document.querySelector(`.tag-chip[data-tag="${val}"]`);
            if (existing) { existing.classList.add('active'); updateTagsHidden(); input.value = ''; return; }
            const chip = document.createElement('span');
            chip.className = 'tag-chip active';
            chip.dataset.tag = val;
            chip.innerHTML = val + '<span class="remove-tag" onclick="event.stopPropagation(); this.parentElement.remove(); updateTagsHidden();">&times;</span>';
            chip.onclick = function() { toggleTag(this); };
            document.getElementById('tagChips').appendChild(chip);
            updateTagsHidden();
            input.value = '';
        }
        document.getElementById('customTagInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); addCustomTag(); }
        });
        // Initialize tags from form_data on page load (for validation re-render)
        (function() {
            const savedTags = document.getElementById('tagsHidden').value;
            if (savedTags) {
                savedTags.split(',').forEach(t => {
                    t = t.trim();
                    if (!t) return;
                    const chip = document.querySelector(`.tag-chip[data-tag="${t}"]`);
                    if (chip) { chip.classList.add('active'); }
                    else { addCustomTag.call(null); /* won't work, need to add dynamically */
                        const c = document.createElement('span');
                        c.className = 'tag-chip active';
                        c.dataset.tag = t;
                        c.innerHTML = t + '<span class="remove-tag" onclick="event.stopPropagation(); this.parentElement.remove(); updateTagsHidden();">&times;</span>';
                        c.onclick = function() { toggleTag(this); };
                        document.getElementById('tagChips').appendChild(c);
                    }
                });
            }
        })();
    </script>
</body>
</html>
