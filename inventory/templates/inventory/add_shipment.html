{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire &amp; Risk Alliance - Add Shipment</title>
    <style>
        :root {
            --md-sys-color-primary: #8b1a1a;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #ffdad5;
            --md-sys-color-on-primary-container: #410001;
            --md-sys-color-secondary: #775652;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #ffdad5;
            --md-sys-color-on-secondary-container: #2c1512;
            --md-sys-color-tertiary: #705c2e;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #fcdfa6;
            --md-sys-color-on-tertiary-container: #261a00;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-background: #fff8f6;
            --md-sys-color-on-background: #201a19;
            --md-sys-color-surface: #fff8f6;
            --md-sys-color-on-surface: #201a19;
            --md-sys-color-on-surface-variant: #534341;
            --md-sys-color-surface-container-lowest: #ffffff;
            --md-sys-color-surface-container-low: #fef1ef;
            --md-sys-color-surface-container: #f8ebe9;
            --md-sys-color-surface-container-high: #f3e5e2;
            --md-sys-color-surface-container-highest: #ede0dd;
            --md-sys-color-surface-dim: #e6d9d6;
            --md-sys-color-outline: #857371;
            --md-sys-color-outline-variant: #d8c2bf;
            --md-sys-color-inverse-surface: #362f2e;
            --md-sys-color-inverse-on-surface: #fbeeeb;
            --md-sys-color-inverse-primary: #ffb4ab;
        }
        body.dark-mode {
            --md-sys-color-primary: #ffb4ab;
            --md-sys-color-on-primary: #690005;
            --md-sys-color-primary-container: #930006;
            --md-sys-color-on-primary-container: #ffdad5;
            --md-sys-color-secondary: #e7bdb7;
            --md-sys-color-on-secondary: #442926;
            --md-sys-color-secondary-container: #5d3f3b;
            --md-sys-color-on-secondary-container: #ffdad5;
            --md-sys-color-tertiary: #dfc38c;
            --md-sys-color-on-tertiary: #3e2e04;
            --md-sys-color-tertiary-container: #574419;
            --md-sys-color-on-tertiary-container: #fcdfa6;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000a;
            --md-sys-color-on-error-container: #ffdad6;
            --md-sys-color-background: #1a1110;
            --md-sys-color-on-background: #ede0dd;
            --md-sys-color-surface: #1a1110;
            --md-sys-color-on-surface: #ede0dd;
            --md-sys-color-on-surface-variant: #d8c2bf;
            --md-sys-color-surface-container-lowest: #120d0c;
            --md-sys-color-surface-container-low: #201a19;
            --md-sys-color-surface-container: #251e1d;
            --md-sys-color-surface-container-high: #2f2827;
            --md-sys-color-surface-container-highest: #3b3332;
            --md-sys-color-surface-dim: #1a1110;
            --md-sys-color-outline: #a08c8a;
            --md-sys-color-outline-variant: #534341;
            --md-sys-color-inverse-surface: #ede0dd;
            --md-sys-color-inverse-on-surface: #362f2e;
            --md-sys-color-inverse-primary: #8b1a1a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d1518 100%);
            color: #fff;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #b8860b;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-brand img { height: 44px; width: auto; }
        .header-brand-text h1 { font-size: 1.1rem; font-weight: 700; color: #fff; line-height: 1.2; }
        .header-brand-text .subtitle { font-size: 0.7rem; color: #b8860b; text-transform: uppercase; letter-spacing: 0.1em; }
        .header a { color: #d4a84b; text-decoration: none; font-size: 0.875rem; font-weight: 500; }
        .header a:hover { color: #fff; }
        .container { max-width: 700px; margin: 24px auto; padding: 0 16px; }

        .form-card {
            background: var(--md-sys-color-surface-container-low); border-radius: 12px; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-card-header {
            background: linear-gradient(135deg, #8b1a1a 0%, #a02020 100%);
            color: #fff; padding: 20px 24px;
        }
        .form-card-header h2 { font-size: 1.125rem; margin-bottom: 4px; }
        .form-card-header p { color: #d4a3a3; font-size: 0.85rem; }

        .form-body { padding: 24px; }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; font-size: 0.8rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--md-sys-color-on-surface); margin-bottom: 6px;
        }
        .form-group .hint {
            font-size: 0.75rem; color: var(--md-sys-color-outline); font-weight: 400;
            text-transform: none; letter-spacing: normal;
        }
        .form-input {
            width: 100%; padding: 10px 14px; border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 8px; font-size: 0.9rem; font-family: inherit;
            background: var(--md-sys-color-surface-container-lowest);
        }
        .form-input:focus { outline: none; border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 2px rgba(139,26,26,0.15); }
        textarea.form-input { resize: vertical; min-height: 60px; }

        .form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
        }

        .form-section {
            border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 20px; margin-top: 20px;
        }
        .form-section h3 {
            font-size: 0.9rem; color: var(--md-sys-color-on-surface); margin-bottom: 12px;
        }

        .pallet-display {
            background: #f0fdf4; border: 2px solid #16a34a; border-radius: 8px;
            padding: 12px 14px; font-size: 1.1rem; font-weight: 700; color: #166534;
            text-align: center;
        }

        .btn-submit {
            width: 100%; padding: 14px; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
            border: none; border-radius: 8px; font-size: 1rem; font-weight: 700;
            cursor: pointer; margin-top: 8px;
        }
        .btn-submit:hover { opacity: 0.9; }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        .error-list {
            background: var(--md-sys-color-error-container); border: 1px solid #fca5a5; border-radius: 8px;
            padding: 12px 16px; margin-bottom: 20px; color: var(--md-sys-color-on-error-container); font-size: 0.85rem;
        }
        .error-list ul { margin: 6px 0 0 16px; }

        .photo-upload-area {
            border: 2px dashed var(--md-sys-color-outline-variant); border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
        }
        .photo-upload-area:hover { border-color: var(--md-sys-color-primary); }
        .photo-upload-area.dragover { border-color: var(--md-sys-color-primary); background: var(--md-sys-color-primary-container); }
        .photo-upload-area p { color: var(--md-sys-color-on-surface-variant); font-size: 0.85rem; }
        .photo-upload-area .icon { font-size: 2rem; margin-bottom: 8px; }
        .photo-preview-list {
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px;
        }
        .photo-preview-item {
            position: relative; width: 80px; height: 80px; border-radius: 8px;
            overflow: hidden; border: 1px solid var(--md-sys-color-outline-variant);
        }
        .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview-item .remove-photo {
            position: absolute; top: 2px; right: 2px; background: rgba(220,38,38,0.9);
            color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px;
            font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .location-custom-wrap { margin-top: 8px; display: none; }

        .nav-links { margin-top: 16px; text-align: center; }
        .nav-links a { color: var(--md-sys-color-primary); text-decoration: none; font-size: 0.875rem; }
        .nav-links a:hover { text-decoration: underline; }

        .tag-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip {
            display: inline-block; padding: 6px 14px; border-radius: 999px;
            font-size: 0.8rem; font-weight: 600; cursor: pointer;
            background: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface-variant); border: 2px solid var(--md-sys-color-outline-variant);
            transition: all 0.15s; user-select: none;
        }
        .tag-chip:hover { border-color: var(--md-sys-color-primary); }
        .tag-chip.active { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border-color: var(--md-sys-color-primary); }
        .tag-chip .remove-tag {
            margin-left: 6px; font-weight: 700; font-size: 0.9rem; cursor: pointer;
        }

        /* Dark mode */
        .dark-toggle {
            background: none; border: 1px solid #b8860b; color: #b8860b;
            padding: 4px 10px; border-radius: 6px; font-size: 0.75rem;
            cursor: pointer; font-weight: 600;
        }
        .dark-toggle:hover { background: rgba(184,134,11,0.2); }

        /* Semantic dark overrides (not covered by M3 variables) */
        body.dark-mode .pallet-display { background: #064e3b; border-color: #16a34a; color: #6ee7b7; }

        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 8px; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/dashboard/" class="header-brand" style="text-decoration:none;">
            <img src="{% static 'inventory/img/logo.png' %}" alt="Fire &amp; Risk Alliance">
            <div class="header-brand-text">
                <h1>Fire &amp; Risk Alliance</h1>
                <div class="subtitle">Inventory Management System</div>
            </div>
        </a>
        <div style="display:flex; align-items:center; gap:12px;">
            <button class="dark-toggle" onclick="toggleDarkMode()" id="darkToggle">Dark Mode</button>
            <a href="/dashboard/">Back to Dashboard</a>
        </div>
    </div>

    <div class="container">
        <div class="form-card">
            <div class="form-card-header">
                <h2>Add New Shipment</h2>
                <p>Enter shipment details to create inventory items and generate QR codes</p>
            </div>
            <div class="form-body">
                {% if errors %}
                <div class="error-list">
                    <strong>Please fix the following:</strong>
                    <ul>
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <form method="POST" id="shipmentForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group">
                            <label>Manufacturer / Supplier</label>
                            <input type="text" name="manufacturer" class="form-input" required
                                value="{{ form_data.manufacturer|default:'' }}" placeholder="e.g. Panasonic">
                        </div>
                        <div class="form-group">
                            <label>Pallet ID <span class="hint">(auto-assigned)</span></label>
                            <div class="pallet-display" id="palletDisplay">{{ next_pallet_id }}</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Project Number</label>
                        <input type="text" name="project_number" class="form-input"
                            value="{{ form_data.project_number|default:'' }}" placeholder="e.g. PRJ-2026-001">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Number of Boxes</label>
                            <input type="number" name="num_boxes" class="form-input" required min="1"
                                value="{{ form_data.num_boxes|default:'' }}" placeholder="e.g. 67">
                        </div>
                        <div class="form-group">
                            <label>Items Per Box <span class="hint">(default qty per box)</span></label>
                            <input type="number" name="items_per_box" class="form-input" required min="1"
                                value="{{ form_data.items_per_box|default:'' }}" placeholder="e.g. 50">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Receiving Location</label>
                            <select name="location" class="form-input" id="locationSelect" onchange="toggleCustomLocation()">
                                <option value="">-- Select Location --</option>
                                {% for loc in location_choices %}
                                <option value="{{ loc }}" {% if form_data.location == loc %}selected{% endif %}>{{ loc }}</option>
                                {% endfor %}
                                <option value="other" {% if form_data.location and form_data.location not in location_choices %}selected{% endif %}>Other (enter below)</option>
                            </select>
                            <div class="location-custom-wrap" id="customLocationWrap">
                                <input type="text" name="location_custom" class="form-input" id="customLocationInput"
                                    placeholder="Enter custom location"
                                    value="{% if form_data.location and form_data.location not in location_choices %}{{ form_data.location }}{% endif %}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Damage Reported?</label>
                            <select name="damaged" class="form-input">
                                <option value="no" {% if form_data.damaged == 'no' %}selected{% endif %}>No</option>
                                <option value="yes" {% if form_data.damaged == 'yes' %}selected{% endif %}>Yes</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Brief Description of Shipment</label>
                        <textarea name="description" class="form-input" placeholder="e.g. Lithium-ion batteries for testing">{{ form_data.description|default:'' }}</textarea>
                    </div>

                    <div class="form-section">
                        <h3>Photos (optional)</h3>
                        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click();">
                            <div class="icon">&#128247;</div>
                            <p>Click to upload photos or drag and drop</p>
                            <p class="hint">Upload photos of the shipment, labels, or damage</p>
                        </div>
                        <input type="file" id="photoInput" name="photos" multiple accept="image/*" style="display:none;" onchange="previewPhotos(this)">
                        <div class="photo-preview-list" id="photoPreviewList"></div>
                    </div>

                    <div class="form-section">
                        <h3>Tags / Keywords</h3>
                        <div class="form-group">
                            <label>Select Tags <span class="hint">(click to toggle)</span></label>
                            <div class="tag-chips" id="tagChips">
                                <span class="tag-chip" data-tag="Standard" onclick="toggleTag(this)">Standard</span>
                                <span class="tag-chip" data-tag="Initiating" onclick="toggleTag(this)">Initiating</span>
                                <span class="tag-chip" data-tag="Target" onclick="toggleTag(this)">Target</span>
                                <span class="tag-chip" data-tag="RP12" onclick="toggleTag(this)">RP12</span>
                                <span class="tag-chip" data-tag="RP48" onclick="toggleTag(this)">RP48</span>
                                <span class="tag-chip" data-tag="RP48-25kW" onclick="toggleTag(this)">RP48-25kW</span>
                                <span class="tag-chip" data-tag="RP48-40kW" onclick="toggleTag(this)">RP48-40kW</span>
                                <span class="tag-chip" data-tag="RP240" onclick="toggleTag(this)">RP240</span>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <input type="text" class="form-input" id="customTagInput" placeholder="Add custom tag..." style="flex:1;">
                                <button type="button" onclick="addCustomTag()" style="padding:8px 16px; background:#8b1a1a; color:#fff; border:none; border-radius:8px; font-size:0.85rem; cursor:pointer;">Add</button>
                            </div>
                            <input type="hidden" name="tags" id="tagsHidden" value="{{ form_data.tags|default:'' }}">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Exceptions (optional)</h3>
                        <div class="form-group">
                            <label>Damaged Box Numbers <span class="hint">(comma-separated, e.g. 3, 7, 12)</span></label>
                            <input type="text" name="damaged_boxes" class="form-input"
                                value="{{ form_data.damaged_boxes|default:'' }}" placeholder="Leave blank if none">
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">Create Items &amp; Generate QR Codes</button>
                </form>
            </div>
        </div>

        <div class="nav-links">
            <a href="/dashboard/">Back to Dashboard</a>
        </div>
    </div>

    <script>
        // Dark mode
        function toggleDarkMode() {
            var isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
            document.getElementById('darkToggle').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
        if (localStorage.getItem('darkMode') === '1') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkToggle').textContent = 'Light Mode';
        }

        function toggleCustomLocation() {
            const select = document.getElementById('locationSelect');
            const wrap = document.getElementById('customLocationWrap');
            const input = document.getElementById('customLocationInput');
            if (select.value === 'other') {
                wrap.style.display = 'block';
                input.required = true;
            } else {
                wrap.style.display = 'none';
                input.required = false;
            }
        }
        // Initialize on page load
        toggleCustomLocation();

        // Photo preview
        function previewPhotos(input) {
            const list = document.getElementById('photoPreviewList');
            list.innerHTML = '';
            Array.from(input.files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item';
                    div.innerHTML = `<img src="${e.target.result}" alt="Photo ${idx + 1}">`;
                    list.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Drag and drop
        const uploadArea = document.getElementById('photoUploadArea');
        const photoInput = document.getElementById('photoInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            photoInput.files = e.dataTransfer.files;
            previewPhotos(photoInput);
        });

        // ---- Tag management ----
        function getSelectedTags() {
            return Array.from(document.querySelectorAll('.tag-chip.active')).map(c => c.dataset.tag);
        }
        function updateTagsHidden() {
            document.getElementById('tagsHidden').value = getSelectedTags().join(',');
        }
        function toggleTag(chip) {
            chip.classList.toggle('active');
            updateTagsHidden();
        }
        function addCustomTag() {
            const input = document.getElementById('customTagInput');
            const val = input.value.trim();
            if (!val) return;
            // Check if already exists
            const existing = document.querySelector(`.tag-chip[data-tag="${val}"]`);
            if (existing) { existing.classList.add('active'); updateTagsHidden(); input.value = ''; return; }
            const chip = document.createElement('span');
            chip.className = 'tag-chip active';
            chip.dataset.tag = val;
            chip.innerHTML = val + '<span class="remove-tag" onclick="event.stopPropagation(); this.parentElement.remove(); updateTagsHidden();">&times;</span>';
            chip.onclick = function() { toggleTag(this); };
            document.getElementById('tagChips').appendChild(chip);
            updateTagsHidden();
            input.value = '';
        }
        document.getElementById('customTagInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); addCustomTag(); }
        });
        // Initialize tags from form_data on page load (for validation re-render)
        (function() {
            const savedTags = document.getElementById('tagsHidden').value;
            if (savedTags) {
                savedTags.split(',').forEach(t => {
                    t = t.trim();
                    if (!t) return;
                    const chip = document.querySelector(`.tag-chip[data-tag="${t}"]`);
                    if (chip) { chip.classList.add('active'); }
                    else { addCustomTag.call(null); /* won't work, need to add dynamically */
                        const c = document.createElement('span');
                        c.className = 'tag-chip active';
                        c.dataset.tag = t;
                        c.innerHTML = t + '<span class="remove-tag" onclick="event.stopPropagation(); this.parentElement.remove(); updateTagsHidden();">&times;</span>';
                        c.onclick = function() { toggleTag(this); };
                        document.getElementById('tagChips').appendChild(c);
                    }
                });
            }
        })();
    </script>
</body>
</html>
